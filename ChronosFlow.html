<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><rect width='100' height='100' rx='22' fill='white'/><rect width='50' height='50' fill='black'/><rect x='50' y='50' width='50' height='50' fill='black'/><rect width='100' height='100' rx='22' fill='none' stroke='black' stroke-width='4'/></svg>">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ChronosFlow</title>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <style>
        /* --- Design Tokens --- */
        :root[data-theme="light"] {
            --bg-app: #FFFFFF;
            --bg-sidebar: #F7F7F5; 
            --bg-agenda-panel: #FAFAFA; 
            --text-primary: #37352F;
            --text-secondary: #787774;
            --border: #E0E0E0;
            --accent: #2383E2;
            --bg-active: rgba(35, 131, 226, 0.08);
            --item-hover: rgba(55, 53, 47, 0.04);
            --item-active: rgba(55, 53, 47, 0.08);
            --danger: #EB5757;
            --success: #27AE60;
            --guide: #E0E0E0;
            --chart-grid: #F0F0F0;
            --agenda-line: #EBEBEB;
            --block-bg: #EAF4FC;
            --block-border: #D3E5F5;
            --block-text: #1C5B8E;
            --past-bg: #F2F2F2;
            --past-pattern: rgba(0, 0, 0, 0.03);
            --badge-bg-normal: #F0F0F0;
            --badge-text-normal: #5A5A5A;
            --badge-bg-countdown: rgba(35, 131, 226, 0.1);
            --badge-border-countdown: rgba(35, 131, 226, 0.25);
            --badge-text-countdown: #2383E2;
            --badge-bg-overtime: #EB5757;
            --badge-text-overtime: #FFFFFF;
            --badge-border-done: #E0E0E0;
            --badge-text-done: #A0A0A0;
            --cal-bg: transparent; 
            --cal-selected-bg: #2383E2;
            --cal-selected-text: #FFFFFF;
            --cal-dot-default: #EB5757;
            --caret-color: #0066FF;
        }

        :root[data-theme="dark"] {
            --bg-app: #191919; 
            --bg-sidebar: #202020;
            --bg-agenda-panel: #222222;
            --text-primary: #ECECEC;
            --text-secondary: #9B9B9B;
            --border: #333333;
            --accent: #4D9CFF; 
            --bg-active: rgba(77, 156, 255, 0.15);
            --item-hover: rgba(255, 255, 255, 0.06);
            --item-active: rgba(255, 255, 255, 0.1);
            --danger: #FF6B6B;
            --success: #6BCB77;
            --guide: #3A3A3A;
            --chart-grid: #2A2A2A;
            --agenda-line: #2F2F2F;
            --block-bg: #2C333A;
            --block-border: #3A4652;
            --block-text: #6BA6E8;
            --past-bg: #1C1C1C;
            --past-pattern: rgba(255, 255, 255, 0.03);
            --badge-bg-normal: #2C2C2C;
            --badge-text-normal: #A0A0A0;
            --badge-bg-countdown: rgba(77, 156, 255, 0.15);
            --badge-border-countdown: rgba(77, 156, 255, 0.3);
            --badge-text-countdown: #4D9CFF;
            --badge-bg-overtime: #E24848;
            --badge-text-overtime: #FFFFFF;
            --badge-border-done: #3A3A3A;
            --badge-text-done: #505050;
            --cal-bg: transparent; 
            --cal-selected-bg: #4D9CFF;
            --cal-selected-text: #FFFFFF;
            --cal-dot-default: #EB5757;
            --caret-color: #00F2FF;
        }

        /* --- Global Reset --- */
        * { box-sizing: border-box; outline: none; -webkit-font-smoothing: antialiased; }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", "PingFang SC", "Hiragino Sans GB", "Microsoft YaHei", sans-serif;
            background: var(--bg-app); color: var(--text-primary);
            margin: 0; display: flex; height: 100vh; width: 100vw;
            overflow: hidden; user-select: none; transition: background 0.3s, color 0.3s;
        }

        input, textarea, select { user-select: text; }

        /* Time Input Customization */
        input[type="time"] { cursor: pointer; }
        [data-theme="dark"] input[type="time"]::-webkit-calendar-picker-indicator {
            filter: invert(1);
        }

        /* --- Sidebar --- */
        .sidebar {
            width: 260px; background: var(--bg-sidebar); border-right: 1px solid var(--border);
            display: flex; flex-direction: column; padding: 20px 12px;
            z-index: 1000; position: relative; flex-shrink: 0;
            backdrop-filter: blur(20px); transition: background 0.3s, transform 0.3s ease;
        }
        
        .brand { 
            display: flex; align-items: center; gap: 10px; padding: 0 12px 24px; 
            font-weight: 600; font-size: 16px; color: var(--text-primary);
        }

        .nav-item { 
            display: flex; align-items: center; gap: 10px; padding: 8px 12px; 
            border-radius: 6px; cursor: pointer; color: var(--text-secondary); 
            font-size: 14px; font-weight: 500; margin-bottom: 2px; transition: all 0.2s;
            position: relative;
        }
        .nav-item:hover { background: var(--item-hover); color: var(--text-primary); }
        .nav-item.active { background: var(--item-active); color: var(--text-primary); font-weight: 600; }
        .nav-item.active svg { color: var(--accent); opacity: 1; }
        .nav-item svg { opacity: 0.8; transition: color 0.2s; flex-shrink: 0; width: 18px; height: 18px; display: block; }

        /* --- Floating Theme Menu --- */
        .theme-floating-menu {
            position: absolute;
            left: calc(100% + 10px);
            bottom: 0;
            background: var(--bg-sidebar);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 6px;
            box-shadow: 0 12px 30px rgba(0,0,0,0.15);
            display: none;
            flex-direction: column;
            width: 130px;
            z-index: 2100;
            backdrop-filter: blur(20px);
        }
        .theme-floating-menu::before {
            content: '';
            position: absolute;
            left: -15px; top: 0; bottom: 0; width: 15px;
        }
        .nav-item:hover .theme-floating-menu {
            display: flex;
        }

        .sidebar-submenu {
            margin-bottom: 8px;
            padding-left: 20px;
        }
        .submenu-item {
            display: flex; align-items: center; gap: 10px; padding: 8px 12px;
            border-radius: 6px; cursor: pointer; color: var(--text-secondary);
            font-size: 13px; transition: all 0.2s;
        }
        .submenu-item:hover { background: var(--item-hover); color: var(--text-primary); }
        .submenu-item.active { color: var(--accent); font-weight: 600; background: var(--bg-active); }

        /* --- Main Content --- */
        .main { 
            flex: 1; display: flex; flex-direction: column; position: relative; overflow-y: auto; 
            width: calc(100vw - 260px); background: var(--bg-app);
            scroll-behavior: smooth;
        }

        .container { padding: 0px 60px 120px 60px; width: 100%; max-width: 1400px; margin: 0 auto; }

        /* Sticky Header */
        .sticky-header {
            position: sticky;
            top: 0;
            background: var(--bg-app);
            z-index: 110;
            padding: 24px 60px 16px 60px; 
            border-bottom: 1px solid var(--border);
            margin-left: -60px;
            margin-right: -60px;
        }

        /* Focus View Layout */
        .focus-layout {
            display: grid; 
            grid-template-columns: 1fr 0px; 
            gap: 0; height: 100%; overflow: hidden;
            transition: grid-template-columns 0.4s cubic-bezier(0.25, 1, 0.5, 1);
        }
        .focus-layout.agenda-open { grid-template-columns: 1fr 340px; }

        .focus-tasks { 
            padding: 0 60px 120px; overflow-y: auto; position: relative; 
        }
        
        /* Focus Agenda Panel */
        .focus-agenda { 
            border-left: 1px solid var(--border); 
            background: var(--bg-agenda-panel); 
            display: flex; flex-direction: column; overflow: hidden;
            min-width: 340px;
            box-shadow: inset 1px 0 0px rgba(0,0,0,0.05); 
            position: relative;
        }

        /* Header Section */
        .header-section { 
            display: flex; align-items: center; justify-content: space-between; flex-wrap: wrap; gap: 20px;
            min-height: 48px;
        }
        
        .page-title { font-size: 40px; font-weight: 800; margin: 0; letter-spacing: -0.04em; line-height: 1; color: var(--text-primary); }
        
        .result-count-badge {
            font-size: 14px; font-weight: 600; color: var(--text-secondary); background: var(--item-hover);
            padding: 4px 12px; border-radius: 20px; margin-left: 16px; vertical-align: middle; font-family: "SF Mono", monospace;
        }

        .page-sub-header {
            margin-top: 24px; margin-bottom: 12px;
            font-size: 18px; font-weight: 600; color: var(--text-primary);
            font-family: "SF Mono", monospace; letter-spacing: -0.5px;
            display: flex; align-items: center; gap: 8px; opacity: 0.8;
        }

        /* Date Widget Container */
        .date-widget-container {
            display: flex;
            align-items: center;
            gap: 16px;
        }

        /* Date Widget */
        .date-widget { text-align: right; color: var(--text-primary); z-index: 10; position: relative; }
        .time-clock { 
            font-family: "SF Mono", SFMono-Regular, ui-monospace, monospace; 
            font-size: 28px; font-weight: 700; letter-spacing: -1.5px; line-height: 1;
            font-variant-numeric: tabular-nums; color: var(--text-primary); opacity: 0.9;
        }
        .date-full { font-size: 12px; font-weight: 500; color: var(--text-secondary); margin-top: 4px; letter-spacing: 0.5px; }
        .weekday-highlight { color: var(--accent); font-weight: 600; margin-left: 6px; }

        /* Agenda Toggle Icon */
        .agenda-toggle-icon {
            width: 36px; height: 36px; border-radius: 8px;
            display: flex; align-items: center; justify-content: center;
            color: var(--text-secondary); cursor: pointer; border: 1px solid var(--border); 
            background: var(--bg-app); 
            transition: all 0.2s;
            box-shadow: 0 1px 2px rgba(0,0,0,0.05);
        }
        .agenda-toggle-icon:hover { background: var(--item-hover); color: var(--text-primary); transform: translateY(-1px); }
        .agenda-toggle-icon:active { transform: translateY(0); }

        /* Agenda Sidebar */
        .agenda-top-bar { display: flex; justify-content: space-between; align-items: center; padding: 20px 20px 10px 20px; flex-shrink: 0; }
        .agenda-label { font-size: 13px; font-weight: 700; color: var(--text-primary); letter-spacing: 0.02em; opacity: 0.8; }
        .sidebar-close-btn { width: 28px; height: 28px; border-radius: 4px; display: flex; align-items: center; justify-content: center; color: var(--text-secondary); border: none; background: transparent; cursor: pointer; transition: all 0.2s; }
        .sidebar-close-btn:hover { background: var(--item-hover); color: var(--text-primary); }
        .calendar-wrapper { padding: 0 20px 16px 20px; border-bottom: 1px solid var(--border); background: var(--cal-bg); flex-shrink: 0; }
        .calendar-nav { display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px; padding-top: 8px; }
        .calendar-title { font-size: 15px; font-weight: 700; color: var(--text-primary); }
        .cal-nav-btn { width: 24px; height: 24px; border-radius: 4px; display: flex; align-items: center; justify-content: center; color: var(--text-secondary); border: none; background: transparent; cursor: pointer; transition: all 0.2s; }
        .cal-nav-btn:hover { background: var(--item-hover); color: var(--text-primary); }
        .calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 2px; text-align: center; }
        .cal-day-label { font-size: 10px; color: var(--text-secondary); font-weight: 600; padding-bottom: 8px; opacity: 0.6; }
        .cal-day { font-size: 13px; height: 32px; display: flex; align-items: center; justify-content: center; border-radius: 6px; cursor: pointer; color: var(--text-secondary); font-weight: 500; transition: all 0.1s; position: relative; }
        .cal-day:hover { background: var(--item-hover); color: var(--text-primary); }
        .cal-day.today { color: var(--accent); font-weight: 800; }
        .cal-day.has-event::after { content: ''; position: absolute; bottom: 4px; left: 50%; transform: translateX(-50%); width: 4px; height: 4px; border-radius: 50%; background: var(--cal-dot-default); opacity: 1; }
        .cal-day.today.has-event::after { background: var(--accent); opacity: 1; }
        .cal-day.selected.has-event::after { background: var(--cal-selected-text); opacity: 0.9; }
        .cal-day.selected { background: var(--cal-selected-bg); color: var(--cal-selected-text); font-weight: 600; box-shadow: 0 2px 6px rgba(0,0,0,0.15); }
        .cal-day.empty { pointer-events: none; }
        .timeline-scroll { flex: 1; overflow-y: auto; position: relative; padding: 0 0 40px; }
        .time-row { display: flex; height: 60px; border-bottom: 1px solid var(--agenda-line); position: relative; cursor: pointer; transition: background 0.1s; }
        .time-row:hover { background: var(--item-hover); }
        .time-row:hover::after { content: '+ 新建'; position: absolute; left: 60px; top: 50%; transform: translateY(-50%); font-size: 12px; color: var(--accent); pointer-events: none; opacity: 1; font-weight: 500; }
        .time-row.past { background: var(--past-bg); background-image: repeating-linear-gradient(45deg, transparent, transparent 10px, var(--past-pattern) 10px, var(--past-pattern) 20px); cursor: default; }
        .time-row.past:hover { background-color: var(--past-bg); }
        .time-row.past:hover::after { content: none; } 
        .time-row.past .time-label { opacity: 0.4; }
        .time-label { width: 50px; text-align: right; padding-right: 12px; font-size: 11px; color: var(--text-secondary); transform: translateY(-7px); font-family: "SF Mono", monospace; font-weight: 500; opacity: 0.7; }
        .time-slot { flex: 1; position: relative; }
        .current-time-line { position: absolute; left: 50px; right: 0; height: 2px; background: var(--danger); z-index: 10; pointer-events: none; opacity: 0.9; }
        .current-time-dot { position: absolute; left: -5px; top: -4px; width: 10px; height: 10px; background: var(--danger); border-radius: 50%; box-shadow: 0 0 0 2px var(--bg-agenda-panel); }
        .task-block { position: absolute; left: 60px; right: 12px; width: calc(100% - 74px); background: var(--block-bg); border: 1px solid var(--block-border); border-left: 3px solid var(--accent); border-radius: 4px; padding: 4px 8px; font-size: 11px; color: var(--block-text); cursor: pointer; transition: transform 0.1s, z-index 0.1s; z-index: 2; display: flex; flex-direction: column; white-space: normal; overflow: visible; }
        .task-block:hover { transform: scale(1.02); z-index: 5; box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
        .block-time { font-size: 9px; opacity: 0.8; font-weight: 600; display: block; margin-bottom: 2px; flex-shrink: 0; font-family: "SF Mono", monospace; }
        .block-title { word-break: break-word; line-height: 1.35; font-weight: 500; }

        /* Nodes */
        .node-row { display: flex; align-items: center; position: relative; width: 100%; padding-left: calc(var(--depth) * 32px); padding-top: 4px; padding-bottom: 4px; padding-right: 8px; border-radius: 6px; transition: background 0.2s ease, opacity 0.2s ease; }
        .node-row:hover { background: var(--item-hover); }
        .node-row.active-row { background: var(--bg-active); }
        .node-row.completed-row { opacity: 0.5; filter: grayscale(0.8); }
        .node-row.completed-row:hover, .node-row.completed-row:focus-within { opacity: 0.95; filter: grayscale(0.2); }
        .node-row::before { content: ''; position: absolute; left: calc(var(--depth) * 32px - 16px); top: 0; bottom: 0; width: 1px; background: var(--guide); display: var(--show-guide); }
        .checkbox { width: 18px; height: 18px; border: 1.5px solid var(--text-secondary); border-radius: 4px; flex-shrink: 0; cursor: pointer; position: relative; margin-right: 12px; transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1); background: transparent; opacity: 0.6; }
        .checkbox:hover { border-color: var(--text-primary); opacity: 1; }
        .checkbox.checked { background: var(--text-secondary); border-color: var(--text-secondary); box-shadow: none; opacity: 1; }
        .checkbox.checked::after { content: ''; position: absolute; left: 5px; top: 2px; width: 4px; height: 8px; border: solid var(--bg-app); border-width: 0 2px 2px 0; transform: rotate(45deg); }
        
        .node-input { 
            background: transparent; border: none; color: var(--text-primary); 
            font-size: 15px; font-family: inherit; line-height: 1.6; padding: 4px 0; 
            flex: 1; width: 100%; min-width: 0; font-weight: 400;
            caret-color: var(--caret-color) !important;
        }
        .node-input.completed { color: var(--text-secondary); text-decoration: line-through; }
        
        .right-actions { display: flex; align-items: center; gap: 4px; margin-left: 12px; opacity: 0; transition: opacity 0.2s; }
        .node-row:hover .right-actions, .node-row.has-time .right-actions, .node-row.active-row .right-actions { opacity: 1; }
        .icon-btn { width: 26px; height: 26px; border-radius: 4px; display: flex; align-items: center; justify-content: center; color: var(--text-secondary); cursor: pointer; border: none; background: transparent; transition: all 0.15s; }
        .icon-btn:hover { background: var(--item-active); color: var(--text-primary); }
        .icon-btn.active { color: var(--accent); background: var(--bg-active); }
        .icon-btn.delete:hover { color: var(--danger); background: rgba(235, 87, 87, 0.15); }
        .time-badge { display: flex; align-items: center; gap: 5px; font-family: "SF Mono", SFMono-Regular, ui-monospace, monospace; font-size: 11px; font-weight: 600; padding: 0 8px; border-radius: 6px; height: 22px; transition: all 0.2s; line-height: 1; min-width: 60px; justify-content: center; cursor: pointer; border: 1px solid transparent; background: var(--badge-bg-normal); color: var(--badge-text-normal); }
        .time-badge.countdown { background: var(--badge-bg-countdown); color: var(--badge-text-countdown); border-color: var(--badge-border-countdown); }
        .time-badge.overtime { background: var(--badge-bg-overtime); color: var(--badge-text-overtime); box-shadow: 0 2px 8px rgba(235, 87, 87, 0.3); animation: pulse-red 2s infinite; }
        .time-badge.final { background: transparent; border-color: var(--badge-border-done); color: var(--badge-text-done); cursor: default; font-weight: 500; }

        /* Stats & Chart Styles */
        .stats-view-container { display: flex; flex-direction: column; gap: 24px; padding-top: 24px; }
        .stats-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 16px; margin-top: 0px; }
        .stat-card { background: var(--bg-sidebar); border: 1px solid var(--border); border-radius: 8px; padding: 20px; display: flex; flex-direction: column; }
        .stat-label { font-size: 12px; color: var(--text-secondary); margin-bottom: 8px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.05em; }
        .stat-value { font-size: 24px; font-weight: 700; font-family: "SF Mono", monospace; color: var(--text-primary); }
        .stat-value-group { display: flex; align-items: baseline; gap: 4px; font-family: "SF Mono", monospace; }
        .stat-val-big { font-size: 24px; font-weight: 700; color: var(--text-primary); }
        .stat-val-small { font-size: 14px; font-weight: 500; color: var(--text-secondary); opacity: 0.7; }
        .stat-percent { font-size: 12px; font-family: "SF Mono", monospace; font-weight: 500; color: var(--text-secondary); margin-top: 6px; }
        .growth-badge { display: inline-flex; align-items: center; gap: 4px; font-size: 12px; font-weight: 600; font-family: "SF Mono", monospace; padding: 4px 8px; border-radius: 4px; margin-left: auto; margin-top: -30px; }
        .growth-up { color: var(--success); background: rgba(39, 174, 96, 0.1); }
        .growth-down { color: var(--danger); background: rgba(235, 87, 87, 0.1); }
        .growth-neutral { color: var(--text-secondary); background: var(--item-hover); }
        .chart-section-full { width: 100%; display: flex; flex-direction: column; }
        .chart-section-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 24px; }
        .chart-box { background: var(--bg-sidebar); border: 1px solid var(--border); border-radius: 8px; padding: 24px; min-height: 400px; display: flex; flex-direction: column; box-shadow: 0 1px 2px rgba(0,0,0,0.02); min-width: 0; }
        .chart-title { font-size: 15px; font-weight: 600; margin-bottom: 24px; color: var(--text-primary); letter-spacing: -0.01em; }
        .canvas-wrapper { flex: 1; position: relative; width: 100%; height: 100%; min-height: 0; }
        .overtime-section { background: var(--bg-sidebar); border: 1px solid var(--border); border-radius: 12px; padding: 24px; box-shadow: 0 1px 2px rgba(0,0,0,0.02); width: 100%; }
        .overtime-list { display: grid; grid-template-columns: repeat(auto-fill, minmax(400px, 1fr)); gap: 16px; margin-top: 16px; }
        .ot-card { background: var(--bg-app); border: 1px solid var(--border); border-left: 4px solid var(--danger); border-radius: 8px; padding: 16px; display: flex; flex-direction: column; gap: 12px; transition: transform 0.2s, box-shadow 0.2s; }
        .ot-card:hover { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(0,0,0,0.05); }
        .ot-card-header { display: flex; justify-content: space-between; align-items: center; gap: 12px; }
        .ot-card-name { font-weight: 600; font-size: 15px; color: var(--text-primary); flex: 1; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .ot-card-badge { font-family: "SF Mono", monospace; font-size: 11px; font-weight: 700; padding: 2px 8px; border-radius: 4px; background: rgba(235, 87, 87, 0.1); color: var(--danger); border: 1px solid rgba(235, 87, 87, 0.2); }
        .ot-card-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 12px; border-top: 1px solid var(--border); padding-top: 12px; }
        .ot-grid-item { display: flex; flex-direction: column; gap: 4px; }
        .ot-grid-label { font-size: 10px; color: var(--text-secondary); text-transform: uppercase; font-weight: 600; letter-spacing: 0.02em; }
        .ot-grid-value { font-family: "SF Mono", monospace; font-size: 13px; font-weight: 600; color: var(--text-primary); }
        .ot-grid-value.highlight { color: var(--danger); }
        .ot-reason-group { display: flex; flex-direction: column; gap: 8px; margin-top: 8px; }
        .ot-reason-select { padding: 6px; border-radius: 4px; background: var(--bg-sidebar); border: 1px solid var(--border); font-size: 12px; color: var(--text-primary); outline: none; width: 100%; cursor: pointer; }
        .ot-reason-custom-input { padding: 6px 10px; border-radius: 4px; background: var(--bg-sidebar); border: 1px solid var(--accent); font-size: 12px; color: var(--text-primary); width: 100%; }
        .range-picker { display: flex; background: var(--item-hover); padding: 3px; border-radius: 8px; width: fit-content; border: 1px solid var(--border); }
        .range-btn { padding: 6px 14px; font-size: 12px; font-weight: 600; border-radius: 6px; border: none; background: transparent; color: var(--text-secondary); cursor: pointer; transition: all 0.2s; }
        .range-btn.active { background: var(--bg-app); color: var(--text-primary); box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .date-picker-row { display: flex; align-items: center; gap: 8px; font-size: 13px; color: var(--text-secondary); }
        .custom-date-input { background: var(--bg-sidebar); border: 1px solid var(--border); color: var(--text-primary); border-radius: 6px; padding: 6px 10px; font-family: inherit; font-size: 12px; }

        /* Dynamic Island */
        .island { position: fixed; bottom: 40px; left: 50%; transform: translateX(-50%); background: #111; color: white; padding: 10px 10px 10px 24px; border-radius: 36px; display: flex; align-items: center; gap: 20px; box-shadow: 0 24px 48px rgba(0,0,0,0.25); z-index: 2000; backdrop-filter: blur(20px) saturate(180%); border: 1px solid rgba(255,255,255,0.1); }
        .timer-val { font-family: "SF Mono", monospace; font-weight: 600; font-size: 20px; }
        .timer-label { font-size: 10px; opacity: 0.7; font-weight: 700; margin-bottom: 2px; }
        .island-title { font-size: 14px; font-weight: 500; max-width: 200px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .stop-btn { background: rgba(255,255,255,0.2); color: white; border: none; width: 32px; height: 32px; border-radius: 50%; display: flex; align-items: center; justify-content: center; cursor: pointer; transition: background 0.2s; }
        .stop-btn:hover { background: var(--danger); }
        
        .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.4); backdrop-filter: blur(4px); z-index: 3000; display: flex; align-items: center; justify-content: center; opacity: 0; pointer-events: none; transition: opacity 0.2s; }
        .modal-overlay.show { opacity: 1; pointer-events: auto; }
        .modal { background: var(--bg-app); width: 400px; max-width: 90%; border-radius: 12px; padding: 24px; box-shadow: 0 20px 60px rgba(0,0,0,0.3); border: 1px solid var(--border); transform: scale(0.96); transition: transform 0.2s; display: flex; flex-direction: column; gap: 16px; }
        .modal-overlay.show .modal { transform: scale(1); }
        .data-area { width: 100%; height: 180px; background: var(--bg-sidebar); border: 1px solid var(--border); border-radius: 6px; padding: 12px; font-family: monospace; resize: none; color: var(--text-secondary); margin: 0; }
        .form-group { display: flex; flex-direction: column; gap: 8px; }
        .form-label { font-size: 12px; font-weight: 600; color: var(--text-secondary); text-transform: uppercase; letter-spacing: 0.5px; }
        .form-input { padding: 10px 12px; border-radius: 6px; border: 1px solid var(--border); background: var(--bg-sidebar); color: var(--text-primary); font-size: 14px; font-family: inherit; width: 100%; transition: border 0.2s; }
        .form-input:focus { border-color: var(--accent); }
        .btn-row { display: flex; justify-content: flex-end; gap: 10px; margin-top: 12px; }
        .btn { padding: 8px 16px; border-radius: 6px; border: none; font-size: 13px; font-weight: 500; cursor: pointer; transition: opacity 0.2s; }
        .btn:hover { opacity: 0.8; }
        .btn-ghost { background: transparent; color: var(--text-secondary); }
        .btn-primary { background: var(--accent); color: white; }
        .mobile-menu-btn { display: none; position: fixed; top: 16px; left: 16px; z-index: 1001; background: var(--bg-app); border: 1px solid var(--border); padding: 8px; border-radius: 8px; }

        /* --- Pro Guide View Styles --- */
        .guide-container { 
            max-width: 1000px; 
            margin: 0 auto; 
            padding: 60px 40px 120px; 
            animation: fadeIn 0.4s ease-out;
        }

        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* Hero Section：采用静谧的深色背景与更柔和的文字 */
        .guide-hero { 
            background: var(--bg-sidebar);
            border: 1px solid var(--border);
            border-radius: 24px; 
            padding: 60px 48px; 
            color: var(--text-primary); 
            margin-bottom: 56px; 
            position: relative;
            overflow: hidden;
            box-shadow: 0 10px 30px rgba(0,0,0,0.05);
        }
        
        /* 装饰用的弥散圆，增加设计感 */
        .guide-hero::before {
            content: ''; position: absolute; top: -100px; right: -100px; 
            width: 300px; height: 300px;
            background: var(--accent); opacity: 0.1; 
            border-radius: 50%; filter: blur(80px);
        }
        
        .guide-hero h2 { 
            margin: 0 0 16px 0; font-size: 36px; font-weight: 800; 
            letter-spacing: -0.03em; color: var(--text-primary);
        }
        .guide-hero p { 
            margin: 0; opacity: 0.7; line-height: 1.8; 
            font-size: 18px; max-width: 640px; 
        }


        .guide-section { margin-bottom: 64px; }
        .guide-section-title { 
            font-size: 20px; font-weight: 700; margin-bottom: 24px; 
            display: flex; align-items: center; gap: 12px; color: var(--text-primary);
        }

        /* 统一卡片布局 */
        .guide-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 24px; }
        
        .guide-card { 
            background: var(--bg-app); border: 1px solid var(--border); 
            border-radius: 16px; padding: 28px; transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            display: flex; flex-direction: column; gap: 12px;
        }
        .guide-card:hover { 
            transform: translateY(-5px); 
            border-color: var(--accent); 
            box-shadow: 0 12px 30px rgba(0,0,0,0.08); 
        }
        .guide-card h4 { margin: 0; color: var(--accent); font-size: 17px; font-weight: 700; }
        .guide-card p { margin: 0; font-size: 14px; color: var(--text-secondary); line-height: 1.6; }

        /* 核心：物理键帽样式 (KBD) */
        .shortcut-column-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 40px; }
        .shortcut-group-full { background: var(--bg-sidebar); border-radius: 16px; padding: 24px; border: 1px solid var(--border); }
        .shortcut-group-label { 
            font-size: 12px; text-transform: uppercase; letter-spacing: 0.1em; 
            color: var(--text-secondary); margin-bottom: 20px; font-weight: 800; opacity: 0.7;
        }
        .shortcut-row-full { 
            display: flex; justify-content: space-between; align-items: center; 
            padding: 12px 0; border-bottom: 1px solid var(--border); 
        }
        .shortcut-row-full:last-child { border: none; }
        .shortcut-name { font-size: 14px; color: var(--text-primary); font-weight: 500; }

        .kbd-group { display: flex; gap: 6px; align-items: center; }

        /* 重点改进：键帽视觉设计 */
        kbd {
            display: inline-flex; align-items: center; justify-content: center;
            min-width: 36px; height: 36px; padding: 0 10px;
            background: var(--bg-app);
            border: 1px solid var(--border);
            border-bottom: 4px solid var(--border);
            border-radius: 8px;
            font-family: "SF Mono", "Consolas", monospace;
            font-size: 15px; font-weight: 800; color: var(--text-primary);
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
            transition: all 0.1s ease;
            cursor: default;
        }
        kbd:active {
            border-bottom-width: 1px;
            transform: translateY(2px);
        }

        @media (max-width: 768px) {
            .guide-grid, .shortcut-column-grid { grid-template-columns: 1fr; }
        }
        
        @media (max-width: 1024px) {
            .focus-layout { grid-template-columns: 1fr; }
            .focus-agenda { position: fixed; right: 0; top: 0; bottom: 0; z-index: 2000; box-shadow: -10px 0 30px rgba(0,0,0,0.1); transform: translateX(100%); transition: transform 0.3s; }
            .focus-layout.agenda-open .focus-agenda { transform: translateX(0); }
            .stats-grid { grid-template-columns: 1fr 1fr; }
            .chart-section-grid { grid-template-columns: 1fr; }
            .overtime-list { grid-template-columns: 1fr; }
            .theme-floating-menu { left: auto; right: 0; bottom: 100%; margin-bottom: 10px; } 
        }

        @media (max-width: 768px) {
            .sidebar { position: absolute; left: -100%; height: 100%; width: 280px; box-shadow: 20px 0 50px rgba(0,0,0,0.3); }
            .sidebar.open { left: 0; }
            .main { width: 100vw; }
            .container { padding: 0 20px 100px; }
            .date-widget { display: none; }
            .mobile-menu-btn { display: block; }
            .stats-grid { grid-template-columns: 1fr; }
            .header-section { flex-direction: column; align-items: flex-start; gap: 10px; padding-bottom: 16px; }
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script>
        const { useState, useEffect, useCallback, useMemo, useRef } = React;
        const h = React.createElement;

        const PRESET_REASONS = ["未分类", "预估不足", "突发中断", "难度较高", "状态不佳", "追求完美"];
        const CUSTOM_OPTION = "自定义...";

        const Icon = (path) => h('svg', {width:18, height:18, viewBox:"0 0 24 24", fill:"none", stroke:"currentColor", strokeWidth:2, strokeLinecap:"round", strokeLinejoin:"round"}, h('path', {d:path}));
        const Icons = {
            Edit: () => Icon("M11 4H4a2 2 0 00-2 2v14a2 2 0 002 2h14a2 2 0 002-2v-7 M18.5 2.5a2.121 2.121 0 013 3L12 15l-4 1 1-4 9.5-9.5z"),
            Stats: () => Icon("M18 20V10M12 20V4M6 20v-6"), 
            Settings: () => Icon("M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 1 1.72v.51a2 2 0 0 1-1 1.72l-.15.1a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l.22-.38a2 2 0 0 0-.73-2.73l-.15-.1a2 2 0 0 1-1-1.72v-.51a2 2 0 0 1 1-1.72l.15-.1a2 2 0 0 0 .73-2.73l-.22-.38a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z M12 15a3 3 0 1 0 0-6 3 3 0 0 0 0 6z"),
            Trash: () => Icon("M3 6h18M19 6v14a2 2 0 01-2 2H7a2 2 0 01-2-2V6m3 0V4a2 2 0 012-2h4a2 2 0 012 2v2"),
            Play: () => h('svg', {width:12, height:12, viewBox:"0 0 24 24", fill:"currentColor", stroke:"none"}, h('polygon', {points:"5 3 19 12 5 21 5 3"})),
            Pause: () => h('svg', {width:12, height:12, viewBox:"0 0 24 24", fill:"currentColor", stroke:"none"}, h('rect', {x:6, y:4, width:4, height:16}), h('rect', {x:14, y:4, width:4, height:16})),
            Clock: () => h('svg', {width:13, height:13, viewBox:"0 0 24 24", fill:"none", stroke:"currentColor", strokeWidth:2.5}, h('circle', {cx:12, cy:12, r:10}), h('path', {d:"M12 6v6l4 2"})),
            Calendar: () => h('svg', {width:18, height:18, viewBox:"0 0 24 24", fill:"none", stroke:"currentColor", strokeWidth:2, strokeLinecap:"round", strokeLinejoin:"round"}, h('rect',{x:3,y:4,width:18,height:18,rx:2,ry:2}), h('line',{x1:16,y1:2,x2:16,y2:6}), h('line',{x1:8,y1:2,x2:8,y2:6}), h('line',{x1:3,y1:10,x2:21,y2:10})),
            Menu: () => Icon("M3 12h18M3 6h18M3 18h18"),
            SidebarIcon: () => h('svg', {width:20, height:20, viewBox:"0 0 24 24", fill:"none", stroke:"currentColor", strokeWidth:2}, h('rect',{x:3,y:4,width:18,height:18,rx:2,ry:2}), h('line',{x1:16,y1:2,x2:16,y2:6}), h('line',{x1:8,y1:2,x2:8,y2:6}), h('line',{x1:3,y1:10,x2:21,y2:10}), h('path', {d:'M8 14h.01'}), h('path', {d:'M12 14h.01'}), h('path', {d:'M16 14h.01'}), h('path', {d:'M8 18h.01'}), h('path', {d:'M12 18h.01'}), h('path', {d:'M16 18h.01'})),
            SidebarClose: () => Icon("M13 5l7 7-7 7M5 12h14"), 
            ChevronLeft: () => Icon("M15 18l-6-6 6-6"),
            ChevronRight: () => Icon("M9 18l6-6-6-6"),
            ChevronDown: () => Icon("M6 9l6 6 6-6"),
            Warning: () => h('svg', {width:12, height:12, viewBox:"0 0 24 24", fill:"none", stroke:"currentColor", strokeWidth:2.5}, h('circle',{cx:12,cy:12,r:10}), h('line',{x1:12,y1:8,x2:12,y2:12}), h('line',{x1:12,y1:16,x2:12,y2:16})),
            Alert: () => h('svg', {width:18, height:18, viewBox:"0 0 24 24", fill:"none", stroke:"currentColor", strokeWidth:2, strokeLinecap:"round", strokeLinejoin:"round"}, h('path', {d:"M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"}), h('line', {x1:12, y1:9, x2:12, y2:13}), h('circle', {cx:12, cy:17, r:1, fill:"currentColor", stroke:"none"})),
            Palette: () => h('svg', {width:18, height:18, viewBox:"0 0 24 24", fill:"none", stroke:"currentColor", strokeWidth:2, strokeLinecap:"round", strokeLinejoin:"round"}, 
                h('path', {d:"M12 2C6.5 2 2 6.5 2 12s4.5 10 10 10c.55 0 1-.45 1-1 0-.28-.11-.53-.29-.71-.3-.3-.29-.8.03-1.08.18-.16.42-.25.66-.25a1.8 1.8 0 0 0 1.77-2.02c-.15-1.39 1.25-2.29 2.5-1.57.51.29 1.17-.06 1.19-.65C19.33 7.73 16.03 2 12 2z"}), 
                h('circle', {cx:13.5, cy:6.5, r:0.5, fill:"currentColor", stroke:"none"}), 
                h('circle', {cx:17.5, cy:10.5, r:0.5, fill:"currentColor", stroke:"none"}), 
                h('circle', {cx:8.5, cy:7.5, r:0.5, fill:"currentColor", stroke:"none"}), 
                h('circle', {cx:6.5, cy:12.5, r:0.5, fill:"currentColor", stroke:"none"})
            ),
            Help: () => h('svg', {width:18, height:18, viewBox:"0 0 24 24", fill:"none", stroke:"currentColor", strokeWidth:2, strokeLinecap:"round", strokeLinejoin:"round"}, 
                h('circle', {cx:12, cy:12, r:10}), 
                h('path', {d:"M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3"}), 
                h('line', {x1:12, y1:17, x2:12.01, y2:17})
            ),
            Bell: () => Icon("M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9m-4.27 13a2 2 0 0 1-3.46 0"),
            BellOff: () => Icon("M13.73 21a2 2 0 0 1-3.46 0M18.63 13A17.89 17.89 0 0 1 18 8 6 6 0 0 0 6 8c0 .7.08 1.37.21 2.03M1 1l22 22")
        };

        const formatTime = (seconds) => {
            const h = Math.floor(Math.abs(seconds) / 3600);
            const m = Math.floor((Math.abs(seconds) % 3600) / 60);
            const s = Math.abs(seconds) % 60;
            return `${h > 0 ? h + ':' : ''}${String(m).padStart(2, '0')}:${String(s).padStart(2, '0')}`;
        };

        const formatTimeFull = (seconds) => {
            const h = Math.floor(Math.abs(seconds) / 3600);
            const m = Math.floor((Math.abs(seconds) % 3600) / 60);
            const s = Math.abs(seconds) % 60;
            if(h > 0) return `${h}h ${m}m ${s}s`;
            return `${m}m ${s}s`;
        };

        const formatTimeStats = (seconds) => {
            const h = Math.floor(Math.abs(seconds) / 3600);
            const m = Math.floor((Math.abs(seconds) % 3600) / 60);
            const s = Math.abs(seconds) % 60;
            return `${String(h).padStart(2, '0')}:${String(m).padStart(2, '0')}:${String(s).padStart(2, '0')}`;
        };
        
        const formatDateKey = (date) => {
            return `${date.getFullYear()}-${String(date.getMonth()+1).padStart(2,'0')}-${String(date.getDate()).padStart(2,'0')}`;
        };

        const getCurrentTimeStr = () => {
            const now = new Date();
            return `${String(now.getHours()).padStart(2, '0')}:${String(now.getMinutes()).padStart(2, '0')}`;
        };

        const DateDisplay = () => {
            const [now, setNow] = useState(new Date());
            useEffect(() => {
                const t = setInterval(() => setNow(new Date()), 1000);
                return () => clearInterval(t);
            }, []);
            return h('div', { className: 'date-widget' },
                h('div', { className: 'time-clock' }, now.toLocaleTimeString('zh-CN', { hour12: false })),
                h('div', { className: 'date-full' }, 
                    h('span', null, now.toLocaleDateString('zh-CN', { year: 'numeric', month: 'long', day: 'numeric' })),
                    h('span', { className: 'weekday-highlight' }, now.toLocaleDateString('zh-CN', { weekday: 'long' }))
                )
            );
        };

        const ChartCanvas = ({ type, data, options, theme }) => {
            const canvasRef = useRef(null);
            const chartInstance = useRef(null);
            useEffect(() => {
                if (!canvasRef.current) return;
                const textColor = theme === 'dark' ? '#9aa0a6' : '#5f6368';
                const finalOptions = {
                    ...options,
                    responsive: true, maintainAspectRatio: false,
                    plugins: {
                        legend: { position: 'bottom', labels: { usePointStyle: true, color: textColor, font: { size: 11, family: 'sans-serif' }, boxWidth: 8, padding: 15 } },
                        ...options.plugins 
                    },
                    scales: options.scales ? options.scales : { x: { display: false }, y: { display: false } },
                    layout: { padding: 10 }
                };
                if (chartInstance.current) chartInstance.current.destroy();
                const ctx = canvasRef.current.getContext('2d');
                chartInstance.current = new Chart(ctx, { type, data, options: finalOptions });
                return () => { if (chartInstance.current) chartInstance.current.destroy(); };
            }, [type, data, options, theme]);
            return h('div', { className: 'canvas-wrapper' }, h('canvas', { ref: canvasRef }));
        };

        const generateColors = (count, theme) => {
            let bases = theme === 'dark' 
                ? ['#5B8FF9', '#5AD8A6', '#F6BD16', '#E8684A', '#6DC8EC', '#9270CA', '#FF9D4D', '#269A99']
                : ['#4E75F6', '#36CFA9', '#F5A623', '#F06565', '#854ECA', '#40A9FF', '#FFC53D', '#597EF7'];
            const colors = [];
            for(let i=0; i<count; i++) colors.push(bases[i % bases.length]);
            return colors;
        };

        const filterByRange = (nodeList, rangeType, customStart, customEnd, isPrevPeriod = false) => {
            const now = new Date();
            const todayKey = formatDateKey(now);
            const currentMonth = now.getMonth();
            const currentYear = now.getFullYear();

            if (isPrevPeriod) {
                if (rangeType === 'day') {
                    const yesterday = new Date(now); yesterday.setDate(now.getDate() - 1);
                    return nodeList.filter(n => n.date === formatDateKey(yesterday));
                }
                if (rangeType === 'week') {
                    return nodeList.filter(n => {
                        if (!n.date) return false;
                        const d = new Date(n.date);
                        const diffTime = (now - d);
                        const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24)); 
                        return diffDays > 7 && diffDays <= 14;
                    });
                }
                if (rangeType === 'month') {
                    let prevMonth = currentMonth - 1;
                    let prevYear = currentYear;
                    if (prevMonth < 0) { prevMonth = 11; prevYear--; }
                    return nodeList.filter(n => {
                            if (!n.date) return false;
                            const [y, m, d] = n.date.split('-').map(Number);
                            return y === prevYear && (m-1) === prevMonth;
                    });
                }
                return [];
            }

            return nodeList.filter(n => {
                if (!n.date) return false;
                if (rangeType === 'day') return n.date === todayKey;
                if (rangeType === 'month') {
                    const [y, m, d] = n.date.split('-').map(Number);
                    return y === currentYear && (m-1) === currentMonth;
                }
                if (rangeType === 'year') {
                        const [y, m, d] = n.date.split('-').map(Number);
                        return y === currentYear;
                }
                if (rangeType === 'week') {
                    const d = new Date(n.date);
                    const diffTime = Math.abs(now - d);
                    const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24)); 
                    return diffDays <= 7;
                }
                if (rangeType === 'custom') {
                    if (!customStart || !customEnd) return true;
                    return n.date >= customStart && n.date <= customEnd;
                }
                return true;
            });
        };

        const EfficiencyWarningView = ({ nodes, theme, onUpdateNode }) => {
            const [range, setRange] = useState('day');
            const [customStart, setCustomStart] = useState(formatDateKey(new Date()));
            const [customEnd, setCustomEnd] = useState(formatDateKey(new Date()));

            const filteredNodes = useMemo(() => filterByRange(nodes, range, customStart, customEnd, false), [nodes, range, customStart, customEnd]);

            const overtimeTasks = useMemo(() => {
                return filteredNodes
                    .filter(n => n.target > 0 && n.time > n.target)
                    .map(n => ({
                        id: n.id,
                        name: n.text || '未命名任务',
                        actual: n.time,
                        target: n.target,
                        exceeded: n.time - n.target,
                        percent: Math.round(((n.time - n.target) / n.target) * 100),
                        reason: n.overtimeReason === undefined ? "未分类" : n.overtimeReason
                    }))
                    .sort((a, b) => b.exceeded - a.exceeded);
            }, [filteredNodes]);

            return h('div', { className: 'container' },
                h('div', { className: 'sticky-header' }, 
                    h('div', { className: 'header-section' },
                        h('div', { style: { display: 'flex', alignItems: 'center' } },
                            h('h1', { className: 'page-title' }, '效率预警'),
                            h('span', { className: 'result-count-badge' }, `累计 ${overtimeTasks.length}`)
                        ),
                        h('div', { style: { display: 'flex', flexDirection: 'column', alignItems: 'flex-end', gap: 8 } },
                            h('div', { className: 'range-picker' }, 
                                ['day', 'week', 'month', 'year', 'custom'].map(r => 
                                    h('button', { 
                                        key: r, 
                                        className: `range-btn ${range === r ? 'active' : ''}`, 
                                        onClick: () => setRange(r) 
                                    }, {day:'今天', week:'本周', month:'本月', year:'全年', custom:'自定义'}[r])
                                )
                            ),
                            range === 'custom' && h('div', { className: 'date-picker-row' },
                                h('input', { type: 'date', className: 'custom-date-input', value: customStart, onChange: e => setCustomStart(e.target.value) }),
                                h('span', null, '至'),
                                h('input', { type: 'date', className: 'custom-date-input', value: customEnd, onChange: e => setCustomEnd(e.target.value) })
                            )
                        )
                    )
                ),
                h('div', { className: 'stats-view-container' },
                    overtimeTasks.length > 0 ? h('div', { className: 'overtime-section' },
                        h('div', { className: 'overtime-list' },
                            overtimeTasks.map((t, i) => {
                                const isPreset = PRESET_REASONS.includes(t.reason);
                                const isCategorized = t.reason !== "未分类";
                                return h('div', { 
                                    key: i, 
                                    className: 'ot-card',
                                    style: { borderLeftColor: isCategorized ? 'var(--success)' : 'var(--danger)' }
                                },
                                    h('div', { className: 'ot-card-header' },
                                        h('span', { className: 'ot-card-name' }, t.name),
                                        h('span', { className: 'ot-card-badge' }, `超时 ${t.percent}%`)
                                    ),
                                    h('div', { className: 'ot-card-grid' },
                                        h('div', { className: 'ot-grid-item' },
                                            h('span', { className: 'ot-grid-label' }, '目标时长'),
                                            h('span', { className: 'ot-grid-value' }, formatTimeFull(t.target))
                                        ),
                                        h('div', { className: 'ot-grid-item' },
                                            h('span', { className: 'ot-grid-label' }, '实际耗时'),
                                            h('span', { className: 'stat-value-group' }, h('span', {className:'ot-grid-value'}, formatTimeFull(t.actual)))
                                        ),
                                        h('div', { className: 'ot-grid-item' },
                                            h('span', { className: 'ot-grid-label' }, '超出时长'),
                                            h('span', { className: 'ot-grid-value highlight' }, `+${formatTimeFull(t.exceeded)}`)
                                        ),
                                        h('div', { className: 'ot-grid-item' },
                                            h('span', { className: 'ot-grid-label' }, '状态'),
                                            h('span', { className: 'ot-grid-value', style: {color: 'var(--danger)'} }, '溢出')
                                        )
                                    ),
                                    h('div', { className: 'ot-reason-group' },
                                        h('select', { 
                                            className: 'ot-reason-select',
                                            value: isPreset ? t.reason : CUSTOM_OPTION,
                                            onChange: (e) => {
                                                const val = e.target.value;
                                                onUpdateNode(t.id, { overtimeReason: val === CUSTOM_OPTION ? "" : val });
                                            }
                                        }, 
                                            PRESET_REASONS.map(r => h('option', {key:r, value:r}, `归因：${r}`)),
                                            h('option', {value: CUSTOM_OPTION}, `${CUSTOM_OPTION}`)
                                        ),
                                        !isPreset && h('input', {
                                            className: 'ot-reason-custom-input',
                                            placeholder: '输入具体自定义原因...',
                                            value: t.reason,
                                            onChange: (e) => onUpdateNode(t.id, { overtimeReason: e.target.value })
                                        })
                                    )
                                );
                            })
                        )
                    ) : h('div', { className: 'chart-box', style: { justifyContent: 'center', alignItems: 'center', color: 'var(--success)', opacity: 0.8, minHeight: '200px' } },
                        h(Icons.Clock), h('span', {style:{marginTop:8, fontWeight:500}}, '该时段内暂无超时任务，效率极高！')
                    )
                )
            );
        };

        const StatsView = ({ nodes, theme, onUpdateNode }) => {
            const [range, setRange] = useState('day');
            const [customStart, setCustomStart] = useState(formatDateKey(new Date()));
            const [customEnd, setCustomEnd] = useState(formatDateKey(new Date()));
            
            const filteredNodes = useMemo(() => filterByRange(nodes, range, customStart, customEnd, false), [nodes, range, customStart, customEnd]);
            const prevFilteredNodes = useMemo(() => filterByRange(nodes, range, customStart, customEnd, true), [nodes, range]);

            const statsData = useMemo(() => {
                const dataNodes = filteredNodes;
                const prevNodes = prevFilteredNodes;

                const totalTime = dataNodes.reduce((acc, n) => acc + n.time, 0);
                const prevTotalTime = prevNodes.reduce((acc, n) => acc + n.time, 0);
                
                let growthRate = 0;
                let hasGrowth = false;
                if (prevTotalTime > 0) {
                    growthRate = ((totalTime - prevTotalTime) / prevTotalTime) * 100;
                    hasGrowth = true;
                } else if (totalTime > 0 && prevTotalTime === 0) {
                    growthRate = 100;
                    hasGrowth = true;
                }

                const totalNodes = dataNodes.length;
                const parentItems = [];
                let currentParent = null;
                dataNodes.forEach(node => {
                    if (node.depth === 0) {
                        if (currentParent) parentItems.push(currentParent);
                        currentParent = { name: node.text || '未命名项目', totalTime: node.time };
                    } else if (currentParent) {
                        currentParent.totalTime += node.time;
                    }
                });
                if (currentParent) parentItems.push(currentParent);
                const activeParents = parentItems.filter(p => p.totalTime > 0).sort((a, b) => b.totalTime - a.totalTime);
                
                let parentsCount = 0;
                let parentCompleted = 0;
                let totalLeaves = 0;
                let completedLeaves = 0;
                let overtimeCompletedLeaves = 0;
                const leafItems = [];

                dataNodes.forEach((node, i) => {
                    const isParent = i < dataNodes.length - 1 && dataNodes[i+1].depth > node.depth;
                    const isLeaf = !isParent;
                    if (node.depth === 0) {
                        parentsCount++;
                        if (node.completed) parentCompleted++;
                    }
                    if (isLeaf) {
                        totalLeaves++; 
                        if (node.completed) {
                            completedLeaves++; 
                            if (node.target > 0 && node.time > node.target) {
                                overtimeCompletedLeaves++;
                            }
                        }
                        if (node.time > 0) {
                            leafItems.push({ name: node.text || '未命名任务', time: node.time });
                        }
                    }
                });

                const prevOvertimeCompletedLeaves = prevNodes.filter(n => n.completed && n.target > 0 && n.time > n.target).length;
                let otGrowthRate = 0;
                let hasOtGrowth = false;
                if (prevOvertimeCompletedLeaves > 0) {
                    otGrowthRate = ((overtimeCompletedLeaves - prevOvertimeCompletedLeaves) / prevOvertimeCompletedLeaves) * 100;
                    hasOtGrowth = true;
                } else if (overtimeCompletedLeaves > 0 && prevOvertimeCompletedLeaves === 0) {
                    otGrowthRate = 100;
                    hasOtGrowth = true;
                }

                leafItems.sort((a, b) => b.time - a.time);
                
                const reasonMap = {};
                dataNodes.filter(n => n.target > 0 && n.time > n.target).forEach(t => {
                    const r = t.overtimeReason || "未分类";
                    reasonMap[r] = (reasonMap[r] || 0) + 1;
                });
                const sortedReasons = Object.entries(reasonMap).sort((a, b) => b[1] - a[1]);

                const trendMap = {};
                const isDayView = range === 'day';
                const trendKeys = [];
                
                if (isDayView) {
                    for(let i=0;i<24;i++) trendKeys.push(`${i}:00`);
                } else {
                   const dates = [...new Set(dataNodes.map(n => n.date))].sort();
                   if(dates.length === 0 && range !== 'custom') {
                       const today = new Date();
                       for(let i=6; i>=0; i--) {
                           const d = new Date(today); d.setDate(today.getDate() - i);
                           trendKeys.push(formatDateKey(d));
                       }
                   } else {
                       dates.forEach(d => trendKeys.push(d));
                   }
                }
                trendKeys.forEach(k => trendMap[k] = 0);
                dataNodes.forEach(n => {
                    if (isDayView) {
                        if (n.startTime) {
                             const parsed = parseInt(n.startTime.split(':')[0]);
                             if(!isNaN(parsed)) {
                                 trendMap[`${parsed}:00`] = (trendMap[`${parsed}:00`] || 0) + n.time;
                             }
                        }
                    } else {
                        if(n.date) trendMap[n.date] = (trendMap[n.date] || 0) + n.time;
                    }
                });   
                const trendLabels = Object.keys(trendMap);
                const trendValues = Object.values(trendMap).map(v => (v / 3600)); 
                const peakBuckets = new Array(24).fill(0);
                dataNodes.forEach(n => {
                    if(n.time > 0 && n.startTime) {
                        const parsed = parseInt(n.startTime.split(':')[0]);
                        if(!isNaN(parsed)) {
                            peakBuckets[parsed] += n.time;
                        }
                    }
                });
                const peakValues = peakBuckets.map(v => (v / 3600));

                return { 
                    totalTime, prevTotalTime, growthRate, hasGrowth,
                    otGrowthRate, hasOtGrowth,
                    totalNodes, activeParents, leafItems, sortedReasons,
                    parentsCount, parentCompleted, totalLeaves, completedLeaves, overtimeCompletedLeaves,
                    trendLabels, trendValues, peakValues
                };
            }, [filteredNodes, prevFilteredNodes, range]);

            const getPercent = (val, total) => {
                if (!total || total === 0) return '0.0%';
                return ((val / total) * 100).toFixed(1) + '%';
            };

            const parentChartData = {
                labels: statsData.activeParents.map(p => p.name),
                datasets: [{ 
                    data: statsData.activeParents.map(p => p.totalTime), 
                    backgroundColor: generateColors(statsData.activeParents.length, theme), 
                    borderWidth: 0, hoverOffset: 6 
                }]
            };
            
            const leafChartData = {
                labels: statsData.leafItems.map(s => s.name),
                datasets: [{ 
                    data: statsData.leafItems.map(s => s.time), 
                    backgroundColor: generateColors(statsData.leafItems.length, theme), 
                    borderWidth: 0, hoverOffset: 6 
                }]
            };

            const trendChartData = {
                labels: statsData.trendLabels,
                datasets: [{
                    label: '专注时长 (小时)',
                    data: statsData.trendValues,
                    backgroundColor: theme === 'dark' ? 'rgba(77, 156, 255, 0.6)' : 'rgba(35, 131, 226, 0.6)',
                    hoverBackgroundColor: theme === 'dark' ? 'rgba(77, 156, 255, 0.9)' : 'rgba(35, 131, 226, 0.9)',
                    borderRadius: 4,
                    barPercentage: 0.6,
                }]
            };

            const safePeakValues = statsData.peakValues || [];
            const isPeakEmpty = safePeakValues.length > 0 && safePeakValues.every(v => v === 0);

            const peakChartData = {
                labels: Array.from({length:24}, (_,i) => `${String(i).padStart(2,'0')}:00`),
                datasets: [{
                    label: '热度',
                    data: safePeakValues,
                    borderColor: isPeakEmpty ? 'transparent' : (theme === 'dark' ? '#FF6B6B' : '#EB5757'),
                    backgroundColor: isPeakEmpty ? 'transparent' : (theme === 'dark' ? 'rgba(255, 107, 107, 0.15)' : 'rgba(235, 87, 87, 0.15)'),
                    borderWidth: 2,
                    tension: 0.4,
                    fill: true,
                    pointRadius: 2,
                    pointBackgroundColor: isPeakEmpty ? 'transparent' : (theme === 'dark' ? '#FF6B6B' : '#EB5757')
                }]
            };

            const reasonChartData = {
                labels: statsData.sortedReasons.map(r => r[0]),
                datasets: [{
                    data: statsData.sortedReasons.map(r => r[1]),
                    backgroundColor: generateColors(statsData.sortedReasons.length, theme),
                    borderRadius: 4,
                }]
            };

            const barOptions = {
                plugins: {
                    legend: { display: false },
                    tooltip: {
                         backgroundColor: theme === 'dark' ? 'rgba(255,255,255,0.9)' : 'rgba(0,0,0,0.8)',
                         titleColor: theme === 'dark' ? '#000' : '#fff',
                         bodyColor: theme === 'dark' ? '#333' : '#fff',
                         displayColors: false,
                         callbacks: { label: (c) => `时长: ${c.raw.toFixed(2)}h` }
                    }
                },
                scales: {
                    x: { grid: { display: false }, ticks: { color: theme === 'dark' ? '#A0A0A0' : '#787774', font: {size:10, family: "SF Mono"}, maxRotation: 0, autoSkip: true, maxTicksLimit: 12 } },
                    y: { grid: { beginAtZero: true, color: theme === 'dark' ? 'rgba(255,255,255,0.05)' : 'rgba(0,0,0,0.03)', borderDash: [4, 4], drawBorder: false }, ticks: { display: false }, border: { display: false } }
                }
            };

            const reasonChartOptions = {
                indexAxis: 'y',
                plugins: { legend: { display: false } },
                scales: {
                    x: { grid: { display: false }, ticks: { stepSize: 1, color: theme === 'dark' ? '#A0A0A0' : '#787774' } },
                    y: { grid: { display: false }, ticks: { color: theme === 'dark' ? '#A0A0A0' : '#787774', font: { weight: '600' } } }
                }
            };

            const pieOptions = {
                plugins: {
                    tooltip: {
                        backgroundColor: theme === 'dark' ? 'rgba(255,255,255,0.9)' : 'rgba(0,0,0,0.8)',
                        titleColor: theme === 'dark' ? '#000' : '#fff',
                        bodyColor: theme === 'dark' ? '#333' : '#fff',
                        callbacks: { 
                            label: function(c) { 
                                let l = c.label || ''; 
                                if(l) l+=': '; 
                                const v = c.raw;
                                const dataset = c.chart.data.datasets[c.datasetIndex];
                                const total = dataset.data.reduce((acc, curr) => acc + curr, 0);
                                const percentage = total > 0 ? ((v / total) * 100).toFixed(1) + '%' : '0.0%';
                                return `${l}${formatTimeFull(v)} (${percentage})`;
                            } 
                        } 
                    }
                },
                scales: { x: { display: false }, y: { display: false } }
            };

            return h('div', { className: 'container' },
                h('div', { className: 'sticky-header' }, 
                    h('div', { className: 'header-section' }, 
                        h('h1', { className: 'page-title' }, '数据洞察'),
                        h('div', { style: { display: 'flex', flexDirection: 'column', alignItems: 'flex-end', gap: 8 } },
                            h('div', { className: 'range-picker' }, 
                                ['day', 'week', 'month', 'year', 'custom'].map(r => 
                                    h('button', { 
                                        key: r, 
                                        className: `range-btn ${range === r ? 'active' : ''}`, 
                                        onClick: () => setRange(r) 
                                    }, {day:'今天', week:'本周', month:'本月', year:'全年', custom:'自定义'}[r])
                                )
                            ),
                            range === 'custom' && h('div', { className: 'date-picker-row' },
                                h('input', { type: 'date', className: 'custom-date-input', value: customStart, onChange: e => setCustomStart(e.target.value) }),
                                h('span', null, '至'),
                                h('input', { type: 'date', className: 'custom-date-input', value: customEnd, onChange: e => setCustomEnd(e.target.value) })
                            )
                        )
                    )
                ),
                
                h('div', { className: 'stats-view-container' },
                    h('div', { className: 'stats-grid' },
                        h('div', { className: 'stat-card' }, 
                            h('span', { className: 'stat-label' }, '总专注时长'), 
                            h('span', { className: 'stat-value' }, formatTimeStats(statsData.totalTime)),
                            (range !== 'year' && range !== 'custom') && h('span', { 
                                className: `growth-badge ${statsData.growthRate > 0 ? 'growth-up' : statsData.growthRate < 0 ? 'growth-down' : 'growth-neutral'}` 
                            }, 
                                statsData.growthRate > 0 ? '↑' : statsData.growthRate < 0 ? '↓' : '-',
                                `${Math.abs(statsData.growthRate).toFixed(1)}%`
                            )
                        ),
                        h('div', { className: 'stat-card' }, 
                            h('span', { className: 'stat-label' }, '完成父项数'), 
                            h('div', { className: 'stat-value-group' },
                                h('span', { className: 'stat-val-big' }, statsData.parentCompleted),
                                h('span', { className: 'stat-val-small' }, `/ ${statsData.parentsCount}`)
                            ),
                            h('span', { className: 'stat-percent' }, getPercent(statsData.parentCompleted, statsData.parentsCount))
                        ),
                        h('div', { className: 'stat-card' }, 
                            h('span', { className: 'stat-label' }, '全部完成数'), 
                            h('div', { className: 'stat-value-group' },
                                h('span', { className: 'stat-val-big' }, statsData.completedLeaves),
                                h('span', { className: 'stat-val-small' }, `/ ${statsData.totalLeaves}`)
                            ),
                            h('span', { className: 'stat-percent' }, getPercent(statsData.completedLeaves, statsData.totalLeaves))
                        ),
                        h('div', { className: 'stat-card' }, 
                            h('span', { className: 'stat-label' }, '超时完成数'), 
                            h('div', { className: 'stat-value-group' },
                                h('span', { className: 'stat-val-big', style:{color:'var(--danger)'} }, statsData.overtimeCompletedLeaves),
                                h('span', { className: 'stat-val-small', style:{color:'var(--danger)', opacity: 0.8} }, `/ ${statsData.completedLeaves}`)
                            ),
                            (range !== 'year' && range !== 'custom') && h('span', { 
                                className: `growth-badge ${statsData.otGrowthRate > 0 ? 'growth-down' : statsData.otGrowthRate < 0 ? 'growth-up' : 'growth-neutral'}` 
                            }, 
                                statsData.otGrowthRate > 0 ? '↑' : statsData.otGrowthRate < 0 ? '↓' : '-',
                                `${Math.abs(statsData.otGrowthRate).toFixed(1)}%`
                            )
                        )
                    ),
                    
                    h('div', { className: 'chart-section-grid' },
                        h('div', { className: 'chart-box' }, 
                            h('div', { className: 'chart-title' }, '父项耗时分布'), 
                            statsData.activeParents.length > 0 
                            ? h(ChartCanvas, { type: 'doughnut', data: parentChartData, theme: theme, options: { ...pieOptions, cutout: '65%', radius: '90%' } }) 
                            : h('div', {style:{flex:1, display:'flex', alignItems:'center', justifyContent:'center', color:'var(--text-secondary)'}}, '暂无数据')
                        ),
                        h('div', { className: 'chart-box' }, 
                            h('div', { className: 'chart-title' }, '子任务占比'), 
                            statsData.leafItems.length > 0 
                            ? h(ChartCanvas, { type: 'pie', data: leafChartData, theme: theme, options: { ...pieOptions, radius: '90%' } }) 
                            : h('div', {style:{flex:1, display:'flex', alignItems:'center', justifyContent:'center', color:'var(--text-secondary)'}}, '暂无数据')
                        )
                    ),

                    statsData.sortedReasons.length > 0 && h('div', { className: 'chart-section-full' },
                        h('div', { className: 'chart-box', style: { minHeight: 300 } },
                            h('div', { className: 'chart-title' }, '超时主因分析'),
                            h(ChartCanvas, { type: 'bar', data: reasonChartData, theme: theme, options: reasonChartOptions })
                        )
                    ),

                    h('div', { className: 'chart-section-full' },
                         h('div', { className: 'chart-box' }, 
                            h('div', { className: 'chart-title' }, range === 'day' ? '今日时段趋势' : '专注时长趋势'),
                            h(ChartCanvas, { type: 'bar', data: trendChartData, theme: theme, options: { ...barOptions, maintainAspectRatio: false } })
                        )
                    ),

                    h('div', { className: 'chart-section-full' },
                        h('div', { className: 'chart-box' }, 
                            h('div', { className: 'chart-title' }, '24小时精力分布'), 
                            h(ChartCanvas, { type: 'line', data: peakChartData, theme: theme, options: { ...barOptions, maintainAspectRatio: false } })
                        )
                    )
                )
            );
        };

        const GuideView = ({ isMac }) => {
            const cmd = isMac ? '⌘' : 'Ctrl';
            const opt = isMac ? '⌥' : 'Alt';

            const shortcutGroups = [
                {
                    group: "系统与视图切换",
                    items: [
                        { name: "切换到 今日焦点", keys: [opt, '1'] },
                        { name: "切换到 效率预警", keys: [opt, '2'] },
                        { name: "切换到 数据洞察", keys: [opt, '3'] },
                        { name: "显示/收起侧边日程", keys: [cmd, 'B'] },
                        { name: "撤销上一步操作", keys: [cmd, 'Z'] },
                        { name: "键盘快捷键弹窗", keys: ['shift', '/'] }
                    ]
                },
                {
                    group: "专注执行逻辑",
                    items: [
                        { name: "启动/暂停当前任务", keys: [cmd, 'Enter'] },
                        { name: "标记完成/取消完成", keys: [cmd, 'D'] },
                        { name: "新建排期任务", keys: [opt, 'N'] },
                        { name: "全局快速定位输入框", keys: ['Space'] },
                        { name: "退出编辑状态", keys: ['Esc'] }
                    ]
                },
                {
                    group: "列表编辑技巧",
                    items: [
                        { name: "向下新建任务行", keys: ['Enter'] },
                        { name: "向上/下移动光标", keys: ['↑ / ↓'] },
                        { name: "任务层级缩进 (子任务)", keys: ['Tab'] },
                        { name: "任务层级提升", keys: ['Shift', 'Tab'] },
                        { name: "删除当前任务行", keys: ['Backspace'] }
                    ]
                }
            ];

            return h('div', { className: 'container' },
                h('div', { className: 'guide-container' },
                    // Hero Section
                    h('div', { className: 'guide-hero' },
                        h('h2', null, '欢迎使用 ChronosFlow'),
                        h('p', null, '这是一个基于“时间块”与“心流追踪”设计的专业工具。它不仅记录你的待办事项，更记录你生命中每一分钟的流转。')
                    ),

                    // 快速上手
                    h('div', { className: 'guide-section' },
                        h('div', { className: 'guide-section-title' }, h(Icons.Play), '核心工作流'),
                        h('div', { className: 'guide-grid' },
                            h('div', { className: 'guide-card' },
                                h('h4', null, '1. 结构化设定任务'),
                                h('p', null, '- 使用 Enter 和 Tab 建立任务层级。'),
                                h('p', null, '- ChronosFlow 采用“时间自动汇总”逻辑，父项的进度会自动根据所有子项计算。')
                            ),
                            h('div', { className: 'guide-card' },
                                h('h4', null, '2. 视觉化排期'),
                                h('p', null, '- 在右侧日程轴点击即可排期。将任务从“清单”变为“日程”，是克服拖延的第一步。'),
                                h('p', null, '- 清单也支持直接计时，告别选择困难症。')
                            ),
                            h('div', { className: 'guide-card' },
                                h('h4', null, '3. 专注与归因'),
                                h('p', null, '- 启动计时，开启心流。如果实际耗时超过了预期，请在预警页面诚实地记录原因，这能帮你持续优化时间掌控力。'),
                                h('p', null, '- 统计面板还有丰富的数据洞察，帮助你发现时间使用的盲点。')
                            ),
                            h('div', { className: 'guide-card' },
                                h('h4', null, '4. 消息通知'),
                                h('p', null, '打开消息通知，系统会在接近预计时间时发出提醒，还可以支持点击通知快速开始/暂停任务。')
                            )
                        )
                    ),

                    // 全量快捷键
                    h('div', { className: 'guide-section' },
                        h('div', { className: 'guide-section-title' }, h(Icons.Settings), '快捷键参考手册'),
                        h('div', { className: 'guide-grid' },
                            shortcutGroups.map(group => h('div', { key: group.group, className: 'shortcut-group-full' },
                                h('div', { className: 'shortcut-group-label' }, group.group),
                                group.items.map(item => h('div', { key: item.name, className: 'shortcut-row-full' },
                                    h('span', { className: 'shortcut-name' }, item.name),
                                    h('div', { className: 'kbd-group' }, item.keys.map(k => h('kbd', { key: k }, k)))
                                ))
                            ))
                        )
                    )
                )
            );
        };

        const ScheduleModal = ({ isOpen, onClose, initialData, onSave }) => {
            const [time, setTime] = useState(initialData?.time || getCurrentTimeStr());
            const [duration, setDuration] = useState(initialData?.duration || 30);
            const [taskName, setTaskName] = useState(initialData?.text || '');
            useEffect(() => {
                if(isOpen && initialData) {
                    setTime(initialData.time || getCurrentTimeStr());
                    setDuration(initialData.duration > 0 ? Math.floor(initialData.duration / 60) : 30);
                    setTaskName(initialData.text || '');
                }
            }, [isOpen, initialData]);
            if (!isOpen) return null;
            return h('div', { className: `modal-overlay ${isOpen ? 'show' : ''}`, onClick: onClose },
                h('div', { className: 'modal', onClick: e => e.stopPropagation() },
                    h('h3', { style: {margin:0} }, initialData?.isNew ? '新建日程任务' : '规划任务时间'),
                    h('div', { className: 'form-group' },
                        h('label', { className: 'form-label' }, '任务名称'),
                        h('input', { 
                            className: 'form-input', 
                            value: taskName,
                            onChange: e => setTaskName(e.target.value),
                            placeholder: '新任务'
                        })
                    ),
                    h('div', { className: 'form-group' },
                        h('label', { className: 'form-label' }, '开始时间'),
                        h('input', { 
                            className: 'form-input', 
                            type: 'time', 
                            value: time, 
                            onChange: e => setTime(e.target.value),
                            onClick: (e) => { try { e.target.showPicker(); } catch(err) {} }
                        })
                    ),
                    h('div', { className: 'form-group' },
                        h('label', { className: 'form-label' }, '预计耗时 (分钟)'),
                        h('input', { className: 'form-input', type: 'number', value: duration, onChange: e => setDuration(e.target.value) })
                    ),
                    h('div', { className: 'btn-row' },
                        h('button', { className: 'btn btn-ghost', onClick: onClose }, '取消'),
                        h('button', { className: 'btn btn-primary', onClick: () => { onSave(taskName, time, duration); onClose(); }}, '确定')
                    )
                )
            );
        };
        
        const AgendaSidebar = ({ nodes, selectedDate, onDateSelect, onTimelineClick, onTaskClick, onClose }) => {
            const [now, setNow] = useState(new Date());
            const [viewDate, setViewDate] = useState(selectedDate);
            const timelineRef = useRef(null);
            useEffect(() => {
                const t = setInterval(() => setNow(new Date()), 1000);
                return () => clearInterval(t);
            }, []);
            useEffect(() => setViewDate(selectedDate), [selectedDate]);
            useEffect(() => {
                if(timelineRef.current) {
                    const h = new Date().getHours();
                    const scrollPos = Math.max(0, (h - 2) * 60); 
                    timelineRef.current.scrollTop = scrollPos;
                }
            }, []);
            const changeMonth = (offset) => {
                const newDate = new Date(viewDate.getFullYear(), viewDate.getMonth() + offset, 1);
                setViewDate(newDate);
            };
            const getTopFromTime = (timeStr) => {
                if(!timeStr) return 0;
                const [h, m] = timeStr.split(':').map(Number);
                return h * 60 + m; 
            };
            const getEndTime = (startStr, durationSecs) => {
                if(!startStr) return '';
                const [h, m] = startStr.split(':').map(Number);
                const totalMinutes = h * 60 + m + Math.floor((durationSecs || 1800) / 60); 
                const endH = Math.floor(totalMinutes / 60) % 24;
                const endM = totalMinutes % 60;
                return `${String(endH).padStart(2,'0')}:${String(endM).padStart(2,'0')}`;
            };
            const hours = Array.from({length: 24}, (_, i) => i); 
            const dateKey = formatDateKey(selectedDate);
            const scheduledNodes = nodes.filter(n => n.startTime && !n.completed && (n.date === dateKey));
            const currentPos = now.getHours() * 60 + now.getMinutes();
            const currentHour = now.getHours();
            const eventDates = useMemo(() => {
                const dates = new Set();
                nodes.forEach(n => { if (n.date) dates.add(n.date); });
                return dates;
            }, [nodes]);
            const daysInMonth = new Date(viewDate.getFullYear(), viewDate.getMonth() + 1, 0).getDate();
            const firstDayOfWeek = new Date(viewDate.getFullYear(), viewDate.getMonth(), 1).getDay(); 
            const calendarCells = [];
            for(let i=0; i<firstDayOfWeek; i++) calendarCells.push(null);
            for(let i=1; i<=daysInMonth; i++) calendarCells.push(i);
            const isToday = (d) => now.getDate() === d && now.getMonth() === viewDate.getMonth() && now.getFullYear() === viewDate.getFullYear();
            const isSelected = (d) => selectedDate.getDate() === d && selectedDate.getMonth() === viewDate.getMonth() && selectedDate.getFullYear() === viewDate.getFullYear();
            const hasEvent = (d) => {
                 if (d === null) return false;
                 const key = formatDateKey(new Date(viewDate.getFullYear(), viewDate.getMonth(), d));
                 return eventDates.has(key);
            };
            return h('div', { className: 'focus-agenda' },
                h('div', { className: 'agenda-top-bar' },
                     h('span', { className: 'agenda-label' }, '日程安排'),
                     h('button', { className: 'sidebar-close-btn', onClick: onClose, title: '收起' }, h(Icons.SidebarClose))
                ),
                h('div', { className: 'calendar-wrapper' },
                    h('div', { className: 'calendar-nav' },
                        h('button', { className: 'cal-nav-btn', onClick: () => changeMonth(-1) }, h(Icons.ChevronLeft)),
                        h('div', { className: 'calendar-title' }, viewDate.toLocaleDateString('zh-CN', { year: 'numeric', month: 'long' })),
                        h('button', { className: 'cal-nav-btn', onClick: () => changeMonth(1) }, h(Icons.ChevronRight))
                    ),
                    h('div', { className: 'calendar-grid' },
                        ['日','一','二','三','四','五','六'].map(d => h('div', { key: d, className: 'cal-day-label' }, d)),
                        calendarCells.map((d, i) => 
                            d === null 
                            ? h('div', { key: `empty-${i}`, className: 'cal-day empty' })
                            : h('div', { 
                                key: d, 
                                className: `cal-day ${isToday(d) ? 'today' : ''} ${isSelected(d) ? 'selected' : ''} ${hasEvent(d) ? 'has-event' : ''}`,
                                onClick: () => onDateSelect(new Date(viewDate.getFullYear(), viewDate.getMonth(), d))
                              }, d)
                        )
                    )
                ),
                h('div', { className: 'timeline-scroll', id: 'timeline', ref: timelineRef },
                    hours.map(hVal => {
                        const isPast = (dateKey === formatDateKey(now)) && (hVal < currentHour);
                        return h('div', { 
                            key: hVal, 
                            className: `time-row ${isPast ? 'past' : ''}`, 
                            onClick: () => !isPast && onTimelineClick(`${String(hVal).padStart(2,'0')}:00`) 
                        },
                            h('div', { className: 'time-label' }, `${hVal}:00`),
                            h('div', { className: 'time-slot' })
                        )
                    }),
                    (dateKey === formatDateKey(now)) && h('div', { className: 'current-time-line', style: { top: currentPos } },
                         h('div', { className: 'current-time-dot' })
                    ),
                    scheduledNodes.map(node => {
                        const top = getTopFromTime(node.startTime);
                        const duration = node.target > 0 ? node.target / 60 : 30; 
                        const endTime = getEndTime(node.startTime, node.target);
                        return h('div', {
                            key: node.id, 
                            className: 'task-block', 
                            style: { top: top, minHeight: Math.max(20, duration) },
                            title: `${node.text} (${node.startTime} - ${endTime})`, onClick: (e) => { e.stopPropagation(); onTaskClick(node); }
                        }, 
                            h('span', { className: 'block-time' }, `${node.startTime} - ${endTime}`), 
                            h('span', { className: 'block-title' }, node.text || '未命名事项')
                        );
                    })
                )
            );
        };
        
        const App = () => {
            const todayStr = formatDateKey(new Date());
            const [nodes, setNodes] = useState(() => {
                const s = localStorage.getItem('cf_pro_v9');
                if (s) {
                    const parsed = JSON.parse(s);
                    return parsed.map(n => { if (!n.date) return { ...n, date: todayStr }; return n; });
                }
                return [
                    { id: '1', text: '🚀 欢迎使用 ChronosFlow（父任务会自动汇总时间）', depth: 0, completed: false, time: 0, target: 0, startTime: '', date: todayStr },
                    { id: '2', text: '快捷键：Enter 新建任务，Tab / Shift+Tab 缩进任务层级', depth: 1, completed: false, time: 0, target: 0, startTime: '', date: todayStr },
                    { id: '3', text: '点击右侧 ▶️ 按钮开始「心流计时」(快捷键：Cmd/Ctrl+Enter)', depth: 1, completed: false, time: 0, target: 0, startTime: '', date: todayStr },
                    { id: '4', text: '点击 📅 图标设定「目标时长」或「排期」（超时会自动记录在预警页）', depth: 1, completed: false, time: 0, target: 1200, startTime: '', date: todayStr },
                    { id: '5', text: '💡 进阶操作', depth: 0, completed: false, time: 0, target: 0, startTime: '', date: todayStr },
                    { id: '6', text: '点击侧边栏「数据洞察」：复盘你的时间分布', depth: 1, completed: false, time: 0, target: 0, startTime: '', date: todayStr },
                    { id: '7', text: '尝试按下 Shift + / 呼出全量快捷键手册', depth: 1, completed: false, time: 0, target: 0, startTime: '', date: todayStr }
                ];
            });
            const [theme, setTheme] = useState(localStorage.getItem('cf_theme') || 'system');
            const [activeId, setActiveId] = useState(null);
            const [isMenuOpen, setIsMenuOpen] = useState(false);
            const [showSettings, setShowSettings] = useState(false);
            const [currentView, setCurrentView] = useState('focus'); 
            const [isAgendaOpen, setIsAgendaOpen] = useState(true);
            const [modalConfig, setModalConfig] = useState({ isOpen: false, data: null, targetIndex: -1 });
            const [selectedDate, setSelectedDate] = useState(new Date());
            const [notificationOn, setNotificationOn] = useState(false);
            const [isSidebarVisible, setIsSidebarVisible] = useState(true);
            const [showShortcuts, setShowShortcuts] = useState(false); // 控制快捷键手册显示
            const [history, setHistory] = useState([]);

            // --- 状态追踪 Refs ---
            // 用于记录哪些节点的哪些类型的通知已经发送过，格式: { "nodeId-alertType": timestamp }
            const sentNotificationsRef = useRef({});

            // 用于记录当前连续专注的时长（秒），这是为了场景二的 Focus Mode
            const currentSessionTimeRef = useRef(0);
            
            // 用于记录上一次检测的分钟数，避免每秒都去解析时间字符串
            const lastMinuteRef = useRef(-1);
            
            const handleUndo = useCallback(() => {
                if (history.length === 0) return;
                const prevState = history[history.length - 1];
                setHistory(prevH => prevH.slice(0, -1));
                setNodes(prevState);
            }, [history]);

            const pushToHistory = (currentState) => {
                setHistory(prev => [...prev, JSON.parse(JSON.stringify(currentState))].slice(-50));
            };

            // --- 通知系统基础设定 ---
            const requestNotificationPermission = useCallback(() => {
                if (!("Notification" in window)) return;
                if (Notification.permission !== "granted") {
                    Notification.requestPermission();
                }
            }, []);

            // 在组件挂载时请求权限
            useEffect(() => {
                requestNotificationPermission();
            }, [requestNotificationPermission]);

            const truncate = (str, len = 20) => str.length > len ? str.slice(0, len) + '...' : str;

            // --- 增强通知发送函数，支持点击交互 ---
            const sendNotification = useCallback((title, body, onInteract = null) => {
                if (!notificationOn) return;
                if (Notification.permission === "granted") {
                    try {
                        const n = new Notification(title, { 
                            body, 
                            requireInteraction: true,
                            silent: false 
                        });
                        // 如果传入了交互回调，绑定点击事件
                        if (onInteract) {
                            n.onclick = (e) => {
                                e.preventDefault();
                                window.focus(); // 点击通知后让浏览器窗口回到前台
                                onInteract();   // 执行具体的操作（如开始计时或完成任务）
                                n.close();      // 操作后关闭通知
                            };
                        }
                    } catch (e) { console.error("Notification failed", e); }
                }
            }, [notificationOn]);

            const toggleNotification = () => {
                if (!notificationOn) {
                    // 如果要开启，先请求权限
                    if ("Notification" in window && Notification.permission !== "granted") {
                        Notification.requestPermission().then(permission => {
                            if (permission === "granted") {
                                setNotificationOn(true);
                                // 发送一个测试通知
                                new Notification("通知已开启", { body: "您将收到任务进度提醒" });
                            }
                        });
                    } else {
                        setNotificationOn(true);
                    }
                } else {
                    setNotificationOn(false);
                }
            };

            const isMac = /Mac|iPod|iPhone|iPad/.test(navigator.platform);

            useEffect(() => {
                const t = theme === 'system' ? (window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light') : theme;
                document.documentElement.setAttribute('data-theme', t);
                localStorage.setItem('cf_theme', theme);
            }, [theme]);
            
            // --- 核心轮询器 (集成计时与通知检测) ---
            useEffect(() => {
                const timer = setInterval(() => {
                    const now = new Date();
                    const currentHour = now.getHours();
                    const currentMin = now.getMinutes();
                    const currentTimeInMins = currentHour * 60 + currentMin;
                    const todayKey = formatDateKey(now);

                    // A. 处理计时与连续专注时长
                    if (activeId) {
                        currentSessionTimeRef.current += 1; // 连续专注 +1秒
                        setNodes(prev => prev.map(n => n.id === activeId ? { ...n, time: n.time + 1 } : n));
                    } else {
                        currentSessionTimeRef.current = 0; // 暂停则重置连续时长
                    }

                    // B. 遍历检查所有任务 (通知逻辑)
                    nodes.forEach(node => {
                        const isToday = node.date === todayKey;
                        const nodeId = node.id;
                        
                        // --- 场景一：日程提醒 (Schedule) ---
                        if (isToday && node.startTime && !node.completed) {
                            const [h, m] = node.startTime.split(':').map(Number);
                            const startInMins = h * 60 + m;
                            const diff = startInMins - currentTimeInMins;

                            // 1. 赛前热身 (提前5分钟)
                            if (diff === 5) {
                                const key = `${nodeId}-prestart`;
                                if (!sentNotificationsRef.current[key]) {
                                    sendNotification(`5分钟后开始 ——${node.text || '未命名任务'}`, "请做好准备");
                                    sentNotificationsRef.current[key] = Date.now();
                                }
                            }

                            // 2. 准点起跑 (时间到且未开始) -> 修改此处支持点击开始
                            if (diff === 0 && activeId !== nodeId) {
                                const key = `${nodeId}-start`;
                                if (!sentNotificationsRef.current[key] || (Date.now() - sentNotificationsRef.current[key] > 60000)) {
                                    sendNotification(
                                        "准备开始", 
                                        `👉 点击此通知立即开始计时：${node.text || '未命名任务'}`,
                                        () => setActiveId(nodeId) // 传入回调：点击通知开启计时
                                    );
                                    sentNotificationsRef.current[key] = Date.now();
                                }
                            }
                        }

                        // --- 场景一续：进度与超时 (Pacing & Overtime) ---
                        if (node.target > 0 && !node.completed) {
                            const ratio = node.time / node.target;
                            
                            // 3. 最后冲刺 (90% - 95%)
                            if (ratio >= 0.9 && ratio < 1.0) {
                                const key = `${nodeId}-90percent`;
                                if (!sentNotificationsRef.current[key]) {
                                    sendNotification("剩余 10% 时间", `${node.text} ——即将结束。\n请加快节奏，准备收尾。`);
                                    sentNotificationsRef.current[key] = Date.now();
                                }
                            }

                            // 4. 终点撞线 (100% - 105%) -> 修改此处支持点击完成
                            if (ratio >= 1.0 && ratio < 1.1) { 
                                const key = `${nodeId}-done`;
                                if (!sentNotificationsRef.current[key]) {
                                    sendNotification(
                                        "时间到了！！", 
                                        `👉 点击此通知标记为完成：${node.text}`,
                                        () => {
                                            // 传入回调：点击通知完成任务并停止计时
                                            setNodes(prev => prev.map(n => n.id === nodeId ? { ...n, completed: true } : n));
                                            setActiveId(null);
                                        }
                                    );
                                    sentNotificationsRef.current[key] = Date.now();
                                }
                            }

                            // 5. 轻度超时 (120% - 125%)
                            if (ratio >= 1.2 && ratio < 1.3) {
                                const key = `${nodeId}-overtime120`;
                                if (!sentNotificationsRef.current[key]) {
                                    sendNotification("效率预警！", `${node.text} 已超时20%。\n遇到阻碍了吗？建议重新评估。`);
                                    sentNotificationsRef.current[key] = Date.now();
                                }
                            }

                            // 6. 严重超时 (150% +)
                            if (ratio >= 1.5) {
                                const key = `${nodeId}-overtime150`;
                                if (!sentNotificationsRef.current[key]) {
                                    sendNotification("亲～严重超时！！", `${node.text} 耗时已达原计划的 1.5 倍。\n建议先暂停或拆解任务。`);
                                    sentNotificationsRef.current[key] = Date.now();
                                }
                            }
                        }
                    });
                    
                    // --- 场景二：专注模式 (Focus Mode) ---
                    // 仅针对当前正在运行的任务 (activeId)
                    if (activeId) {
                        const sessionSecs = currentSessionTimeRef.current;
                        
                        // 1. 番茄钟 (25分钟 = 1500秒)
                        if (sessionSecs === 1500) { 
                            sendNotification("🍅 您已经连续专注 25 分钟", "专注力不错！\n深呼吸，远眺 20 秒。");
                        }

                        // 2. 长时休息 (45分钟 = 2700秒)
                        if (sessionSecs === 2700) {
                            sendNotification("☕ 大脑缺氧提醒", "您已连续专注 45 分钟。\n站起来活动一下，喝杯水吧。");
                        }
                    }

                }, 1000); // 保持每秒执行

                return () => clearInterval(timer);
            }, [activeId, nodes, sendNotification]); // 依赖项包含 nodes 确保读取最新状态

            useEffect(() => localStorage.setItem('cf_pro_v9', JSON.stringify(nodes)), [nodes]);

            useEffect(() => {
                const handleGlobalKeyDown = (e) => {
                    const ctrlCmd = isMac ? e.metaKey : e.ctrlKey;
                    const altOpt = e.altKey;

                    // 逻辑：如果不是在输入框内，且按下了 ? (shift + /)
                    if (e.key === '?' && e.target.tagName !== 'INPUT' && e.target.tagName !== 'TEXTAREA') {
                        e.preventDefault();
                        setShowShortcuts(true);
                    }

                    // --- 新增：按下 Esc 关闭手册 ---
                    if (e.key === 'Escape' && showShortcuts) {
                        setShowShortcuts(false);
                    }

                    if (altOpt && e.code === 'KeyN') {
                        e.preventDefault();
                        const nowStr = getCurrentTimeStr();
                        handleTimelineClick(nowStr);
                        return;
                    }

                    if (ctrlCmd && e.code === 'KeyZ') {
                        e.preventDefault();
                        handleUndo();
                        return;
                    }

                    if (altOpt) {
                        if (e.code === 'Digit1') setCurrentView('focus');
                        if (e.code === 'Digit2') setCurrentView('warnings');
                        if (e.code === 'Digit3') setCurrentView('stats');
                    }

                    if (ctrlCmd && e.code === 'KeyB') {
                        e.preventDefault();
                        setIsAgendaOpen(prev => !prev);
                    }

                    if (currentView === 'focus' && e.code === 'Space') {
                        const activeEl = document.activeElement;
                        if (!activeEl || (activeEl.tagName !== 'INPUT' && activeEl.tagName !== 'TEXTAREA')) {
                            e.preventDefault();
                            const inputs = document.querySelectorAll('.focus-tasks .node-input');
                            if (inputs.length > 0) {
                                inputs[inputs.length - 1].focus();
                            }
                        }
                    }
                    // 1. 敲击问号键 (Shift + /) 弹出手册
                    // 注意：要避开正在输入框输入的情况
                    if (e.key === '?' && e.target.tagName !== 'INPUT' && e.target.tagName !== 'TEXTAREA') {
                        e.preventDefault();
                        setShowShortcuts(true);
                    }

                    // 2. 如果手册已经打开，按下 Esc 键关闭它
                    if (e.key === 'Escape' && showShortcuts) {
                        setShowShortcuts(false);
                    }
                };

                window.addEventListener('keydown', handleGlobalKeyDown);
                return () => window.removeEventListener('keydown', handleGlobalKeyDown);
            }, [isMac, currentView, nodes, history, handleUndo, showShortcuts]); 

            const updateNode = useCallback((id, updates) => {
                pushToHistory(nodes);
                setNodes(prev => prev.map(n => n.id === id ? { ...n, ...updates } : n));
            }, [nodes]);

            const handleCreateNewTaskAtBottom = () => {
                pushToHistory(nodes);
                const dateKey = formatDateKey(new Date());
                const newNode = { 
                    id: Date.now().toString(), text: '', depth: 0, completed: false, 
                    time: 0, target: 0, startTime: '', date: dateKey 
                };
                setNodes(prev => [...prev, newNode]);
                setSelectedDate(new Date());
                setTimeout(() => {
                    const inputs = document.querySelectorAll('.focus-tasks .node-input');
                    if(inputs.length > 0) inputs[inputs.length - 1].focus();
                }, 50);
            };

            const getVisibleDescendantIndices = useCallback((visibleList, idx) => {
                const indices = [];
                const parentDepth = visibleList[idx].depth;
                for (let i = idx + 1; i < visibleList.length; i++) {
                    if (visibleList[i].depth <= parentDepth) break;
                    indices.push(i);
                }
                return indices;
            }, []);

            const handleDelete = (originalIndex) => {
                pushToHistory(nodes);
                const newNodes = [...nodes];
                newNodes.splice(originalIndex, 1);
                setNodes(newNodes);
            };

            const handleToggleComplete = (originalIndex, visibleList, visibleIndex) => {
                pushToHistory(nodes);
                const newNodes = [...nodes];
                const targetNode = newNodes[originalIndex];
                const newState = !targetNode.completed;
                targetNode.completed = newState;
                const descendants = getVisibleDescendantIndices(visibleList, visibleIndex);
                descendants.forEach(visIdx => {
                    const globalIdx = visibleList[visIdx]._globalIndex;
                    newNodes[globalIdx].completed = newState;
                });
                if (newState === false && targetNode.depth > 0) {
                    let currentDepth = targetNode.depth;
                    for (let i = visibleIndex - 1; i >= 0; i--) {
                        if (visibleList[i].depth < currentDepth) {
                            const parentGlobalIdx = visibleList[i]._globalIndex;
                            newNodes[parentGlobalIdx].completed = false; 
                            currentDepth = visibleList[i].depth; 
                            if (currentDepth === 0) break; 
                        }
                    }
                }
                if (activeId === targetNode.id && targetNode.completed) setActiveId(null);
                setNodes(newNodes);
            };

            const openScheduleModal = (index, data = null) => {
                const node = nodes[index];
                const initialData = data || { text: node.text, time: node.startTime || '', duration: node.target, isNew: false };
                setModalConfig({ isOpen: true, data: initialData, targetIndex: index });
                setIsAgendaOpen(true);
            };

            const handleSaveSchedule = (text, time, duration) => {
                pushToHistory(nodes);
                const newNodes = [...nodes];
                const idx = modalConfig.targetIndex;
                const dateKey = formatDateKey(selectedDate);
                if(idx === -1) { 
                    const newNode = { 
                        id: Date.now().toString(), text: text, depth: 0, 
                        completed: false, time: 0, target: duration * 60, startTime: time, date: dateKey 
                    };
                    setNodes([...newNodes, newNode]);
                } else if(newNodes[idx]) {
                    newNodes[idx].text = text; 
                    newNodes[idx].startTime = time;
                    newNodes[idx].target = duration * 60;
                    if(!newNodes[idx].date) newNodes[idx].date = dateKey;
                    setNodes(newNodes);
                }
            };

            const handleTimelineClick = (timeStr) => {
                 setModalConfig({ isOpen: true, data: { text: '新任务', time: timeStr, duration: 30, isNew: true }, targetIndex: -1 });
                 setIsAgendaOpen(true);
            };

            const handleKeyDown = (e, originalIndex, visibleIndex, visibleNodes) => {
                const node = nodes[originalIndex];
                const ctrlCmd = isMac ? e.metaKey : e.ctrlKey;
                const visibleInputs = Array.from(document.querySelectorAll('.focus-tasks .node-input'));

                if (e.key === 'Escape') {
                    e.preventDefault();
                    e.target.blur();
                    return;
                }

                if (ctrlCmd && e.key === 'Enter') {
                    e.preventDefault();
                    handleToggleTimer(node, originalIndex);
                    return;
                }

                if (ctrlCmd && e.key.toLowerCase() === 'd') {
                    e.preventDefault();
                    handleToggleComplete(originalIndex, visibleNodes, visibleIndex);
                    return;
                }

                if (e.key === 'ArrowUp') {
                    e.preventDefault();
                    if (visibleIndex > 0) visibleInputs[visibleIndex - 1].focus();
                }
                if (e.key === 'ArrowDown') {
                    e.preventDefault();
                    if (visibleIndex < visibleInputs.length - 1) visibleInputs[visibleIndex + 1].focus();
                }

                if (e.key === 'Enter') {
                    e.preventDefault();
                    pushToHistory(nodes);
                    const newNodes = [...nodes];
                    newNodes.splice(originalIndex + 1, 0, { 
                        id: Date.now().toString(), text: '', depth: node.depth, completed: false, time: 0, target: 0, startTime: '', date: formatDateKey(selectedDate) 
                    });
                    setNodes(newNodes);
                    setTimeout(() => {
                        const newInputs = Array.from(document.querySelectorAll('.focus-tasks .node-input'));
                        if(newInputs[visibleIndex + 1]) newInputs[visibleIndex + 1].focus();
                    }, 50);
                }
                if (e.key === 'Backspace' && node.text === '') { 
                    e.preventDefault(); 
                    if (visibleIndex > 0) visibleInputs[visibleIndex - 1].focus();
                    handleDelete(originalIndex); 
                }
                if (e.key === 'Tab') {
                    e.preventDefault();
                    pushToHistory(nodes);
                    const newNodes = [...nodes];
                    if (e.shiftKey) { if(node.depth > 0) newNodes[originalIndex].depth--; }
                    else { if (node.depth < 5) newNodes[originalIndex].depth++; }
                    setNodes(newNodes);
                }
            };

            const handleToggleTimer = (node, index) => {
                const isActive = activeId === node.id;
                if (!isActive && !node.startTime) {
                     const now = new Date();
                     const timeStr = `${String(now.getHours()).padStart(2,'0')}:${String(now.getMinutes()).padStart(2,'0')}`;
                     const newNodes = [...nodes];
                     newNodes[index].startTime = timeStr;
                     if (!newNodes[index].date) newNodes[index].date = formatDateKey(now);
                     setNodes(newNodes);
                }
                setActiveId(isActive ? null : node.id);
            };

            const activeNode = nodes.find(n => n.id === activeId);
            const activeTheme = theme === 'system' ? (window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light') : theme;
            const dateKey = formatDateKey(selectedDate);
            const visibleNodes = nodes.map((n, i) => ({ ...n, _globalIndex: i })).filter(n => n.date === dateKey);

            const uncategorizedCount = useMemo(() => {
                return nodes.filter(n => 
                    n.completed && 
                    n.target > 0 && 
                    n.time > n.target && 
                    (!n.overtimeReason || n.overtimeReason === "未分类" || n.overtimeReason === "")
                ).length;
            }, [nodes]);

            return h('div', { style: { display: 'flex', width: '100%', height: '100%' } },
                h('button', { className: 'mobile-menu-btn', onClick: () => setIsMenuOpen(!isMenuOpen) }, h(Icons.Menu)),
                h('aside', { className: `sidebar ${isMenuOpen ? 'open' : ''}` },
                    h('div', { className: 'brand' }, h('div', { style: { width: 18, height: 18, background: 'var(--text-primary)', borderRadius: 4} }), h('span', null, 'ChronosFlow')),
                    h('div', { className: `nav-item ${currentView === 'focus' ? 'active' : ''}`, onClick: () => { setCurrentView('focus'); setIsMenuOpen(false); } }, h(Icons.Edit), h('span', null, '今日焦点')),
                    h('div', { className: `nav-item ${currentView === 'warnings' ? 'active' : ''}`, onClick: () => { setCurrentView('warnings'); setIsMenuOpen(false); } }, h(Icons.Alert), h('span', null, '效率预警'), uncategorizedCount > 0 && h('span', { style: { marginLeft: 'auto', background: 'var(--danger)', color: 'white', fontSize: '10px', fontWeight: '700', padding: '2px 6px', borderRadius: '10px', minWidth: '18px', textAlign: 'center' } }, uncategorizedCount)),
                    h('div', { className: `nav-item ${currentView === 'stats' ? 'active' : ''}`, onClick: () => { setCurrentView('stats'); setIsMenuOpen(false); } }, h(Icons.Stats), h('span', null, '数据洞察')),
                    h('div', { className: 'nav-item', onClick: () => setShowSettings(true) }, h(Icons.Settings), h('span', null, '数据备份')),
                    
                    h('div', { style: { marginTop: 'auto' } }),
                    h('div', { className: `nav-item ${currentView === 'guide' ? 'active' : ''}`, onClick: () => { setCurrentView('guide'); setIsMenuOpen(false); } }, h(Icons.Help), h('span', null, '使用说明')),
                    h('div', { className: 'nav-item' }, 
                        h(Icons.Palette), 
                        h('span', null, '主题方案'),
                        h('div', { className: 'theme-floating-menu' },
                            ['light', 'dark', 'system'].map(t => h('div', { 
                                key: t, 
                                className: `submenu-item ${theme === t ? 'active' : ''}`, 
                                onClick: () => setTheme(t) 
                            }, h('span', null, t === 'light' ? '浅色模式' : t === 'dark' ? '深色模式' : '跟随系统')))
                        )
                    ),
                    h('div', { 
                        className: `nav-item ${notificationOn ? 'active' : ''}`, 
                        onClick: toggleNotification 
                    }, 
                        notificationOn ? h(Icons.Bell) : h(Icons.BellOff), // 根据状态切换图标
                        h('span', null, notificationOn ? '通知提醒: 开' : '通知提醒: 关')
                    )
                ),
                h('main', { className: 'main' },
                    currentView === 'guide' 
                    ? h(GuideView, { isMac: isMac })    
                    : currentView === 'stats' 
                    ? h(StatsView, { nodes, theme: activeTheme, onUpdateNode: updateNode })
                    : currentView === 'warnings'
                    ? h(EfficiencyWarningView, { nodes, theme: activeTheme, onUpdateNode: updateNode })
                    : h('div', { className: `focus-layout ${isAgendaOpen ? 'agenda-open' : ''}` },
                        h('div', { className: 'focus-tasks' },
                            h('div', { className: 'sticky-header' }, 
                                h('div', { className: 'header-section' }, 
                                    h('div', { style: {display:'flex', alignItems:'center', gap:12} }, 
                                        h('h1', { className: 'page-title' }, 'Focus')
                                    ),
                                    h('div', { className: 'date-widget-container' },
                                        h(DateDisplay),
                                        !isAgendaOpen && h('button', { 
                                            className: 'agenda-toggle-icon', 
                                            onClick: () => setIsAgendaOpen(true), 
                                            title: '展开日程' 
                                        }, h(Icons.Calendar))
                                    )
                                )
                            ),
                            h('div', { className: 'page-sub-header' }, selectedDate.toLocaleDateString('zh-CN', { year:'numeric', month:'2-digit', day:'2-digit' }).replace(/\//g, '-')),
                            h('div', { style: {marginTop: 12} }, 
                                visibleNodes.length === 0 
                                    ? h('div', { style: { color: 'var(--text-secondary)', padding: '20px 0', cursor: 'pointer', opacity: 0.7 }, onClick: handleCreateNewTaskAtBottom }, '点击此处创建一个新的今日焦点任务...')
                                    : visibleNodes.map((node, idx) => {
                                        const descendants = getVisibleDescendantIndices(visibleNodes, idx);
                                        let effectiveTime = node.time;
                                        let effectiveTarget = node.target;
                                        if (descendants.length > 0) { effectiveTime += descendants.reduce((sum, i) => sum + visibleNodes[i].time, 0); if (effectiveTarget === 0) { effectiveTarget = descendants.reduce((sum, i) => sum + visibleNodes[i].target, 0); } }
                                        const isActive = activeId === node.id;
                                        const isCountdown = effectiveTarget > 0;
                                        const isOvertime = isCountdown && effectiveTime >= effectiveTarget;
                                        const hasTime = effectiveTime > 0 || isCountdown || isActive;
                                        const timeText = (!node.completed && isCountdown) ? (isOvertime ? `+${formatTime(effectiveTime - effectiveTarget)}` : formatTime(effectiveTarget - effectiveTime)) : formatTime(effectiveTime);
                                        return h('div', { key: node.id, className: `node-row ${hasTime ? 'has-time' : ''} ${isActive ? 'active-row' : ''} ${node.completed ? 'completed-row' : ''}`, style: { '--depth': node.depth, '--show-guide': node.depth > 0 ? 'block' : 'none' } },
                                            h('div', { className: `checkbox ${node.completed ? 'checked' : ''}`, onClick: () => handleToggleComplete(node._globalIndex, visibleNodes, idx) }),
                                            h('input', { 
                                                className: `node-input ${node.completed ? 'completed' : ''}`, 
                                                value: node.text, 
                                                onChange: e => { const n = [...nodes]; n[node._globalIndex].text = e.target.value; setNodes(n); }, 
                                                onKeyDown: e => handleKeyDown(e, node._globalIndex, idx, visibleNodes), 
                                                placeholder: '输入任务...' 
                                            }),
                                            h('div', { className: 'right-actions' }, !node.completed && h('button', { className: `icon-btn ${isActive ? 'active' : ''}`, onClick: () => handleToggleTimer(node, node._globalIndex) }, isActive ? h(Icons.Pause) : h(Icons.Play)), !node.completed && h('button', { className: `icon-btn ${node.startTime ? 'active' : ''}`, onClick: () => openScheduleModal(node._globalIndex), title: node.startTime ? `已排期: ${node.startTime}` : '排期' }, h(Icons.Calendar)), h('div', { className: `time-badge ${node.completed ? 'final' : ''} ${!node.completed && isCountdown ? 'countdown' : ''} ${!node.completed && isOvertime ? 'overtime' : ''}`, onClick: () => openScheduleModal(node._globalIndex) }, isOvertime && !node.completed && h(Icons.Warning), isCountdown && !isOvertime && !node.completed && h(Icons.Clock), h('span', null, timeText)), h('button', { className: 'icon-btn delete', onClick: () => handleDelete(node._globalIndex) }, h(Icons.Trash)))
                                        );
                                    })
                            )
                        ),
                        h(AgendaSidebar, { nodes, selectedDate, onDateSelect: setSelectedDate, onTimelineClick: handleTimelineClick, onTaskClick: (node) => { const idx = nodes.findIndex(n => n.id === node.id); if(idx !== -1) openScheduleModal(idx); }, onClose: () => setIsAgendaOpen(false) })
                    ),
                    activeNode && h('div', { className: 'island' }, h('div', { style: {display:'flex', flexDirection:'column', alignItems:'flex-end'} }, h('div', { className: 'timer-label', style: { color: activeNode.time > activeNode.target && activeNode.target > 0 ? 'var(--danger)' : '#aaa' } }, 'Focusing'), h('div', { className: 'timer-val' }, formatTime(activeNode.time))), h('div', { style: { width:1, height:24, background:'rgba(255,255,255,0.1)'} }), h('div', { className: 'island-title' }, activeNode.text), h('button', { className: 'stop-btn', onClick: () => setActiveId(null) }, h(Icons.Pause)))
                ),
                showSettings && h('div', { className: `modal-overlay show` }, h('div', { className: 'modal' }, h('h3', {style:{margin:'0 0 16px'}}, '数据备份'), h('textarea', { className: 'data-area', readOnly: true, value: JSON.stringify(nodes, null, 2) }), h('div', { style:{display:'flex', justifyContent:'flex-end'} }, h('button', { className: 'btn btn-primary', onClick: () => setShowSettings(false) }, '关闭')))),
                h(ScheduleModal, { isOpen: modalConfig.isOpen, initialData: modalConfig.data, onClose: () => setModalConfig({...modalConfig, isOpen: false}), onSave: handleSaveSchedule }),
                h(ShortcutCheatSheet, { isOpen: showShortcuts, onClose: () => setShowShortcuts(false), isMac: isMac })
            );
        };

        // 快捷键弹窗组件
        const ShortcutCheatSheet = ({ isOpen, onClose, isMac }) => {
            if (!isOpen) return null;
            const cmd = isMac ? '⌘' : 'Ctrl';
            const opt = isMac ? '⌥' : 'Alt';

            const list = [
                { name: '显示/隐藏此帮助', keys: ['shift','/'] },
                { name: "切换到 今日焦点", keys: [opt, '1'] },
                { name: "切换到 效率预警", keys: [opt, '2'] },
                { name: "切换到 数据洞察", keys: [opt, '3'] },
                { name: "显示/收起侧边日程", keys: [cmd, 'B'] },
                { name: "撤销上一步操作", keys: [cmd, 'Z'] },
                { name: "启动/暂停当前任务", keys: [cmd, 'Enter'] },
                { name: "标记完成/取消完成", keys: [cmd, 'D'] },
                { name: "新建排期任务", keys: [opt, 'N'] },
                { name: "全局快速定位输入框", keys: ['Space'] },
                { name: "退出编辑状态", keys: ['Esc'] },
                { name: "向下新建任务行", keys: ['Enter'] },
                { name: "向上/下移动光标", keys: ['↑ / ↓'] },
                { name: "任务层级缩进 (子任务)", keys: ['Tab'] },
                { name: "任务层级提升", keys: ['Shift', 'Tab'] },
                { name: "删除当前任务行", keys: ['Backspace'] }
            ];

            return h('div', { 
                className: 'modal-overlay show', 
                style: { zIndex: 5000 }, 
                onClick: onClose 
            },
                h('div', { 
                    className: 'modal', 
                    style: { width: '500px', padding: '32px' },
                    onClick: e => e.stopPropagation() 
                },
                    h('div', { style: { display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '24px' } },
                        h('h2', { style: { margin: 0, fontSize: '20px' } }, '键盘快捷键'),
                        h('button', { className: 'icon-btn', onClick: onClose }, '✕')
                    ),
                    h('div', { style: { display: 'grid', gridTemplateColumns: 'repeat(2, 1fr)', columnGap: '48px', rowGap: '2px' } },
                        list.map(item => h('div', { 
                            key: item.name, 
                            style: { display: 'flex', justifyContent: 'space-between', alignItems: 'center', padding: '8px 0', borderBottom: '1px solid var(--border)' } 
                        },
                            h('span', { style: { fontSize: '14px', opacity: 0.8 } }, item.name),
                            h('div', { className: 'kbd-group' }, item.keys.map(k => h('kbd', { key: k, style: { height: '24px', minWidth: '24px', fontSize: '12px', borderBottomWidth: '2px' } }, k)))
                        ))
                    ),
                    h('div', { style: { marginTop: '24px', fontSize: '12px', color: 'var(--text-secondary)', textAlign: 'center' } }, '按下 Esc 或点击空白处关闭')
                )
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(h(App));
    </script>
</body>
</html>